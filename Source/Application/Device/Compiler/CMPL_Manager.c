// File Name:	CMPL_Manager.c
// Description:	Compiler Module Manager
// Engineer:	Takahiko Minaga
// Last Edit:	14.08.12
// Revision:	00
//
// Copyright (C) by Fuji Xerox Advanced Technology Co.,Ltd. All rights reserved.
//


/////////////////////////////////////////////////////////////////////////////////////////
// Include File
/////////////////////////////////////////////////////////////////////////////////////////

#include "FinisherCommon.h"
#include "MSP_EventID.h"
#include "MSP_Service.h"
#include "CCdiSysOpeMode.h"
#include "CMPL_Manager.h"
#include "CMPL_STPL_Boundary.h"
#include "CMPL_EJCT_Boundary.h"
#include "CMPL_TMP_Boundary.h"
#include "CNvmInformer.h"


/////////////////////////////////////////////////////////////////////////////////////////
// Private Data Definition
/////////////////////////////////////////////////////////////////////////////////////////

#define CMPL_EJECT_PROCESS_SIZE_THRESH 		2970 //2160								// ópéÜîréÜé¿é{ÇÃópéÜí∑Ëáíl(Å~0.1[mm])
#define CMPL_DISTANCE_CMPEXTSNRTOEXITROLL 	30.0								// Compiler Exit SensorÇ©ÇÁExit RollÇ‹Ç≈ÇÃãóó£(Å~1[mm])
#define CMPL_DISTANCE_EXITROLLRAD			10.0								// Exit RollÇÃîºåa(Å~1[mm])
#define CMPL_PUNCHFILTERTIME				30									// ÉpÉìÉ`åäå„í[åÎåüímÉtÉBÉãÉ^éûä‘(Å~1[ms])

typedef enum
{
	CMPL_MDL_ID_EJCT,
	CMPL_MDL_ID_STPL,
	CMPL_MDL_ID_TMP,
	CMPL_MDL_ID_NUM,
} ECMPL_ModuleID;

typedef struct
{
	UC link;
	ECMPL_ModuleID moduleID;
} SCMPL_CompoCont;

typedef enum /* ECMPL_SequenceId */
{
	CMPL_SEQ_ID_POWER_ON_INIT,
	CMPL_SEQ_ID_RESUME_INIT,
	CMPL_SEQ_ID_NORMAL_INIT,
	CMPL_SEQ_ID_SHEET_INIT,
	CMPL_SEQ_ID_COMPILE_FINISHING,
	CMPL_SEQ_ID_EJECT_FINISHING,
	CMPL_SEQ_ID_STANDBY_EJECT_FINISHING,
	CMPL_SEQ_ID_PROC_END,
	CMPL_SEQ_ID_JAM_CLEAR_ASSIST,

	CMPL_SEQ_ID_NUM,
} ECMPL_SequenceId;

typedef struct
{
	US actID;
	US nextBit;
	US condBit;
} SCMPL_MdlActSeq;


typedef struct
{
	ECMPL_SequenceId sequenceId;
	UL  actionLog; //US -> UL 
	UC sheetNo;
} SCMPL_SeqMng;

#define CMPL_COMPO_CHAIN	12
// Component Control Table
static const SCMPL_CompoCont cCMPL_CompoContTbl[] = {
//	  Link		Compiler Module ID
	{ 20,		CMPL_MDL_ID_EJCT	},
	{ 21,		CMPL_MDL_ID_EJCT	},
	{ 22,		CMPL_MDL_ID_EJCT	},
	{ 30,		CMPL_MDL_ID_TMP		},
	{ 31,		CMPL_MDL_ID_TMP		},
	{ 32,		CMPL_MDL_ID_TMP		},
	{ 33,		CMPL_MDL_ID_TMP		},
	{ 34,		CMPL_MDL_ID_TMP		},
	{ 35,		CMPL_MDL_ID_TMP		},
	{ 36,		CMPL_MDL_ID_TMP		},	// For Test
	{ 40,		CMPL_MDL_ID_TMP		},
	{ 41,		CMPL_MDL_ID_TMP		},
	{ 42,		CMPL_MDL_ID_TMP		},
	{ 43,		CMPL_MDL_ID_TMP		},
	{ 44,		CMPL_MDL_ID_TMP		},
	{ 45,		CMPL_MDL_ID_TMP		},
	{ 46,		CMPL_MDL_ID_TMP		},	// For Test
	{ 50,		CMPL_MDL_ID_STPL	},
	{ 51,		CMPL_MDL_ID_STPL	},
	{ 52,		CMPL_MDL_ID_STPL	},	// For Test
};

#define CMPL_SHTMNGNUM	4

typedef struct
{
	ECMPL_State state;
	UC ejectPossible;
	SCMPL_SeqMng seqMngInfo[CMPL_SHTMNGNUM];
	UC lastStaSeqIndex;
	UC compileSheet;
	US sheetInitAction[SHEETNO_NUM];
	UC  lastOffset;    //(TB- )SetTopÇÃOffsetèÓïÒÇ™NVMÇ…ê≥ÇµÇ≠èëÇ¢ÇƒÇ¢Ç»Ç¢ 
	// Å´Å´Å´(V3.0.6) CompileJobÇÃèàóùëOÅAStandbyÇ…ëJà⁄Ç∑ÇÈTBÇÃëŒçÙ
	UC  finishingWaitSheet; 	
} SCMPL_Manager;

static SCMPL_Manager gCMPL_Manager;

#define CMPLMDLACTBIT_STAPLEHEADHOME		GET_BIT_PATTERN(CMPL_MDL_ACT_STAPLE_HEAD_HOME)
#define CMPLMDLACTBIT_EJECTORHOME			GET_BIT_PATTERN(CMPL_MDL_ACT_EJECTOR_HOME)
#define CMPLMDLACTBIT_STAPLEHARIOUT			GET_BIT_PATTERN(CMPL_MDL_ACT_STAPLE_HARIOUT)
#define CMPLMDLACTBIT_PADDLEHOME			GET_BIT_PATTERN(CMPL_MDL_ACT_PADDLE_HOME)
#define CMPLMDLACTBIT_PADDLECOMPILE			GET_BIT_PATTERN(CMPL_MDL_ACT_PADDLE_COMPILE)
#define CMPLMDLACTBIT_EJECT					GET_BIT_PATTERN(CMPL_MDL_ACT_EJECT)
#define CMPLMDLACTBIT_TAMPSIZEPOS			GET_BIT_PATTERN(CMPL_MDL_ACT_TAMP_SIZE_POS)
#define CMPLMDLACTBIT_CURRENTOFF           	GET_BIT_PATTERN(CMPL_MDL_ACT_CURRENT_OFF)  //V3.6.93
#define CMPLMDLACTBIT_TAMPMISSREGI		GET_BIT_PATTERN(CMPL_MDL_ACT_TAMP_MISS_REGI)  //V3.5.95
//#define CMPLMDLACTBIT_SHEETCOMPILEWAIT		GET_BIT_PATTERN(CMPL_MDL_ACT_SHEET_COMPILE_WAIT)
#define CMPLMDLACTBIT_NORMAL_TAMPING		GET_BIT_PATTERN(CMPL_MDL_ACT_NORMAL_TAMPING)
#define CMPLMDLACTBIT_EJECT_TAMPING			GET_BIT_PATTERN(CMPL_MDL_ACT_EJECT_TAMPING)
#define CMPLMDLACTBIT_STAPLE				GET_BIT_PATTERN(CMPL_MDL_ACT_STAPLE)
#define CMPLMDLACTBIT_OFFSET				GET_BIT_PATTERN(CMPL_MDL_ACT_OFFSET)
#define CMPLMDLACTBIT_RETURN				GET_BIT_PATTERN(CMPL_MDL_ACT_RETURN)
#define CMPLMDLACTBIT_END					GET_BIT_PATTERN(CMPL_MDL_ACT_END)

// Sequence table of "Compiler Module Action"
static const SCMPL_MdlActSeq cCMPL_PowerOnInitSeq[] = {
	{ CMPL_MDL_ACT_START,					CMPLMDLACTBIT_STAPLEHEADHOME,		0,								},
	{ CMPL_MDL_ACT_STAPLE_HEAD_HOME,		CMPLMDLACTBIT_STAPLEHARIOUT,		0,								},
	{ CMPL_MDL_ACT_STAPLE_HARIOUT,			CMPLMDLACTBIT_END,			0,								},
	{ CMPL_MDL_ACT_END,						0,									0,								}
};

static const SCMPL_MdlActSeq cCMPL_ResumeInitSeq[] = {
	{ CMPL_MDL_ACT_START,					CMPLMDLACTBIT_STAPLEHEADHOME,		0,								},
	{ CMPL_MDL_ACT_STAPLE_HEAD_HOME,		CMPLMDLACTBIT_STAPLEHARIOUT,			0,								},
	{ CMPL_MDL_ACT_STAPLE_HARIOUT,		CMPLMDLACTBIT_END,						0,								},
	{ CMPL_MDL_ACT_END,						0,									0,								}
};

static const SCMPL_MdlActSeq cCMPL_NormalInitSeq[] = {
	{ CMPL_MDL_ACT_START,					CMPLMDLACTBIT_STAPLEHEADHOME,		0,								},
	{ CMPL_MDL_ACT_STAPLE_HEAD_HOME,		CMPLMDLACTBIT_STAPLEHARIOUT,		0,								},
	{ CMPL_MDL_ACT_STAPLE_HARIOUT,			CMPLMDLACTBIT_EJECTORHOME,			0,								},
	{ CMPL_MDL_ACT_EJECTOR_HOME,			CMPLMDLACTBIT_END,					0,								},
	{ CMPL_MDL_ACT_END,						0,									0,								}
};

static const SCMPL_MdlActSeq cCMPL_SheetInitSeq[] = {
	{ CMPL_MDL_ACT_START,					CMPLMDLACTBIT_TAMPSIZEPOS,			0,								},
	{ CMPL_MDL_ACT_TAMP_SIZE_POS,			CMPLMDLACTBIT_PADDLEHOME,				0,								},
	{ CMPL_MDL_ACT_PADDLE_HOME,				CMPLMDLACTBIT_EJECTORHOME,			0,								},
	{ CMPL_MDL_ACT_EJECTOR_HOME,			CMPLMDLACTBIT_END,					0,								},
	{ CMPL_MDL_ACT_END,						0,									0,								}
};

static const SCMPL_MdlActSeq cCMPL_CompileFinishingSeq[] = {
	{ CMPL_MDL_ACT_START,					CMPLMDLACTBIT_PADDLECOMPILE | CMPLMDLACTBIT_NORMAL_TAMPING ,	0},
	{ CMPL_MDL_ACT_PADDLE_COMPILE, 			CMPLMDLACTBIT_END,		CMPLMDLACTBIT_NORMAL_TAMPING		},	
	{ CMPL_MDL_ACT_NORMAL_TAMPING,			CMPLMDLACTBIT_END,		CMPLMDLACTBIT_PADDLECOMPILE		},
	{ CMPL_MDL_ACT_END, 					0,									0		}

};
static const SCMPL_MdlActSeq cCMPL_EjectFinishingSeq[] = {

	{ CMPL_MDL_ACT_START,					CMPLMDLACTBIT_PADDLECOMPILE | CMPLMDLACTBIT_EJECT_TAMPING,		0	},
	{ CMPL_MDL_ACT_PADDLE_COMPILE,			CMPLMDLACTBIT_STAPLE | CMPLMDLACTBIT_TAMPMISSREGI,		CMPLMDLACTBIT_EJECT_TAMPING	},
	{ CMPL_MDL_ACT_EJECT_TAMPING,			CMPLMDLACTBIT_STAPLE | CMPLMDLACTBIT_TAMPMISSREGI,		CMPLMDLACTBIT_PADDLECOMPILE	},
	
	{ CMPL_MDL_ACT_STAPLE,					CMPLMDLACTBIT_OFFSET,									CMPLMDLACTBIT_TAMPMISSREGI },
	{ CMPL_MDL_ACT_TAMP_MISS_REGI, 			CMPLMDLACTBIT_OFFSET, 									CMPLMDLACTBIT_STAPLE },
	{ CMPL_MDL_ACT_OFFSET,					CMPLMDLACTBIT_RETURN | CMPLMDLACTBIT_EJECT	,	0					},
	{ CMPL_MDL_ACT_RETURN,					CMPLMDLACTBIT_END,					CMPLMDLACTBIT_EJECT				},
	{ CMPL_MDL_ACT_EJECT,					CMPLMDLACTBIT_END,					CMPLMDLACTBIT_RETURN			},
	{ CMPL_MDL_ACT_END,						0,									0								}

};

static const SCMPL_MdlActSeq cCMPL_StandbyEjectFinishingSeq[] = {

	{ CMPL_MDL_ACT_START,					CMPLMDLACTBIT_PADDLECOMPILE | CMPLMDLACTBIT_EJECT_TAMPING,		0	},
	{ CMPL_MDL_ACT_PADDLE_COMPILE,			CMPLMDLACTBIT_STAPLE | CMPLMDLACTBIT_TAMPMISSREGI,		CMPLMDLACTBIT_EJECT_TAMPING },
	{ CMPL_MDL_ACT_EJECT_TAMPING,			CMPLMDLACTBIT_STAPLE | CMPLMDLACTBIT_TAMPMISSREGI,		CMPLMDLACTBIT_PADDLECOMPILE },

	{ CMPL_MDL_ACT_STAPLE,					CMPLMDLACTBIT_OFFSET,									CMPLMDLACTBIT_TAMPMISSREGI },
	{ CMPL_MDL_ACT_TAMP_MISS_REGI,			CMPLMDLACTBIT_OFFSET,									CMPLMDLACTBIT_STAPLE },
	{ CMPL_MDL_ACT_OFFSET,					CMPLMDLACTBIT_RETURN | CMPLMDLACTBIT_EJECT	,	0					},
	{ CMPL_MDL_ACT_RETURN,					CMPLMDLACTBIT_END,					CMPLMDLACTBIT_EJECT 			},
	{ CMPL_MDL_ACT_EJECT,					CMPLMDLACTBIT_END,					CMPLMDLACTBIT_RETURN			},
	{ CMPL_MDL_ACT_END, 					0,									0								}
	
};

static const SCMPL_MdlActSeq cCMPL_ProcEndSeq[] = {
	{ CMPL_MDL_ACT_START,					CMPLMDLACTBIT_STAPLEHEADHOME,		0,								},
//	{ CMPL_MDL_ACT_STAPLE_HEAD_HOME,		CMPLMDLACTBIT_END,					0,								},
	{ CMPL_MDL_ACT_STAPLE_HEAD_HOME,		CMPLMDLACTBIT_CURRENTOFF,			0,								},
	{ CMPL_MDL_ACT_CURRENT_OFF,			CMPLMDLACTBIT_END,					0,								},
	{ CMPL_MDL_ACT_END,						0,									0,								}
};

static const SCMPL_MdlActSeq cCMPL_JamClearAssist[] = {
	{ CMPL_MDL_ACT_START,					CMPLMDLACTBIT_STAPLEHEADHOME,		0,								},
	{ CMPL_MDL_ACT_STAPLE_HEAD_HOME,		CMPLMDLACTBIT_END,					0,								},
	{ CMPL_MDL_ACT_END,						0,									0,								}
};

static const SCMPL_MdlActSeq* cCMPL_ModuleActionSequence[CMPL_SEQ_ID_NUM] = {
	cCMPL_PowerOnInitSeq,
	cCMPL_ResumeInitSeq,
	cCMPL_NormalInitSeq,
	cCMPL_SheetInitSeq,
	cCMPL_CompileFinishingSeq,
	cCMPL_EjectFinishingSeq,
	cCMPL_StandbyEjectFinishingSeq,
	cCMPL_ProcEndSeq,
	cCMPL_JamClearAssist,
};

/////////////////////////////////////////////////////////////////////////////////////////
// Private Function Prototype Definition
/////////////////////////////////////////////////////////////////////////////////////////
static US CMPL_GetUnStapleEjectThresh(US aMaxProcSize, UC  aSheetNo);
static US CMPL_GetStapleEjectThresh(UC aSheetNo);

static bool CMPL_DownCompCheck();
static bool CMPL_CheckEjectPossible();
static void CMPL_ClearSequenceManageInfo(UC aIndex);
static void CMPL_PowerOnInit(EAction aAction);
static void CMPL_StartPowerOnInit();
static void CMPL_CompletePowerOnInit();
static void CMPL_StopPowerOnInit();
static void CMPL_ResumeInit(EAction aAction);
static void CMPL_StartResumeInit();
static void CMPL_CompleteResumeInit();
static void CMPL_StopResumeInit();
static void CMPL_NormalInit(EAction aAction);
static void CMPL_StartNormalInit();
static void CMPL_CompleteNormalInit();
static void CMPL_StopNormalInit();
static void CMPL_SheetInitialize(UC aSheetNo, EAction aAction);
static void CMPL_StartSheetInitialize(UC aSheetNo);
static void CMPL_CompleteSheetInitialize(UC aIndex);
static void CMPL_StopSheetInitialize(UC aSheetNo);
static void CMPL_ProcessEnd(EAction aAction);
static void CMPL_StartProcessEnd();
static void CMPL_CompleteProcessEnd();
static void CMPL_StopProcessEnd();
static void CMPL_JamClearAssist(EAction aAction);
static void CMPL_StartJamClearAssist();
static void CMPL_CompleteJamClearAssist();
static void CMPL_StopJamClearAssist();
static void CMPL_CompilerAction(UC aSheetNo, EAction aAction);
static void CMPL_StartCompilerAction(UC aSheetNo);
static void CMPL_CompleteCompilerAction(UC aIndex);
static void CMPL_StopCompilerAction(UC aSheetNo);

static void CMPL_ExecuteSequence(ECMPL_ModuleAction aCompAct, UC aSeqMngIdx);

//static void CMPL_ExitRollReleaseWait(UC aSheetNo);
//static US CMPL_GetExitRollReleaseTime(UC aSheetNo);
//static void CMPL_SheetCompileWait(UC aSheetNo);
//static US CMPL_GetSheetCompileTime(UC aSheetNo);

static void CMPL_CurrentOFF(UC aSheetNo);
static void CMPL_EventTimerTimeUp(SS aTimerID, UL aSheetNo);

static void CMPL_CompileExitSensorON(UC aSheetNo);
static void CMPL_CompileExitSensorOFF(UC aSheetNo);
static void CMPL_CompileSheetEject();
static void CMPL_SheetAttributeUpdate(UC aSheetNo);
static void CMPL_SheetAbort();
static void CMPL_SheetDelivered();

static void CMPL_ChangeStartUpEvent();
static void CMPL_ChangePowerUpEvent();
static void CMPL_ChangePowerOnEvent();
static void CMPL_ChangePowerDownEvent();
static void CMPL_ChangePowerOffEvent();
static void CMPL_ChangeChangingStandbyEvent();
static void CMPL_ChangeStandbyEvent();
static void CMPL_ChangeCycleUpEvent();
static void CMPL_ChangeReadyEvent();

static void CMPL_ChangeChangingDiagEvent();
static void CMPL_ChangeDiagEvent();
static void CMPL_ChangeHardDownEvent();
static void CMPL_ChangeCycleDownEvent();
static void CMPL_ChangeProcDownEvent();



/////////////////////////////////////////////////////////////////////////////////////////
// Function Body (Sequence)
/////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetEjectExecutionSheetReq
// Description   : ëŒè€ÉVÅ[ÉgÇ…ëŒÇµÇƒÅAï™äÑîréÜÇé¿é{Ç∑ÇÈÇ©/ÇµÇ»Ç¢Ç©ÇéÊìæ
//				 : (ëŒè€ÉVÅ[ÉgÇÃéüópéÜÇÃèÓïÒÇ»Çµ)
// Parameter     : sheetNo(ëŒè€ÉVÅ[Ég)
// Return        : eject(é¿é{Ç∑ÇÈÅFSHT_EJECT_EXECÅAé¿é{ÇµÇ»Ç¢ÅFSHT_EJECT_NOT)
///////////////////////////////////////////////////////////////////
EShtEject CMPL_GetEjectExecutionSheetReq(UC sheetNo)
{
	EShtEject eject;
	US ejectThresh, stackCount, maxProcSize;

	if( SRVC_GetDestinationFinish(sheetNo) == eCdiFinOutDest_OutTray ) {
		stackCount = SRVC_GetWeightedCompileCount(sheetNo);						// Å~0.1[ñá]
		maxProcSize = SRVC_GetMaxProcessSizeCompile(sheetNo);

		if( SRVC_GetStapleMode(sheetNo) == eCdiFinStaple_Off ) {
			ejectThresh = CMPL_GetUnStapleEjectThresh(maxProcSize, sheetNo);
		}
		else {																	// Stapleé¿é{
			ejectThresh = CMPL_GetStapleEjectThresh(sheetNo);
		}

		if( stackCount > ejectThresh ) {
			eject = SHT_EJECT_EXEC;
		}
		else {																	// 50ñáí¥Ç¶
			eject = SHT_EJECT_NOT;
		}
	}
	else {																		// îréÜêÊÇ™OutTrayà»äO
		eject = SHT_EJECT_EXEC;
	}
//	PutCMPLManagerLog(0x33,eject,stackCount,ejectThresh);

	return eject;
}


///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetEjectExecutionNextSheetReq
// Description   : ëŒè€ÉVÅ[ÉgÇ…ëŒÇµÇƒÅAï™äÑîréÜÇé¿é{Ç∑ÇÈÇ©/ÇµÇ»Ç¢Ç©ÇéÊìæ
//				 : (ëŒè€ÉVÅ[ÉgÇÃéüópéÜÇÃèÓïÒÇ†ÇË)
// Parameter     : sheetNo(ëŒè€ÉVÅ[Ég)
// Return        : eject(é¿é{Ç∑ÇÈÅFSHT_EJECT_EXECÅAé¿é{ÇµÇ»Ç¢ÅFSHT_EJECT_NOT)
///////////////////////////////////////////////////////////////////
EShtEject CMPL_GetEjectExecutionNextSheetReq(UC sheetNo, UC nextShtNo)
{
	EShtEject eject;
	US ejectThresh, stackCount, maxProcSize, nextShtProcSize;

	if( SRVC_GetDestinationFinish(sheetNo) == eCdiFinOutDest_OutTray ) {
		stackCount = SRVC_GetWeightedCompileCount(sheetNo) + CMPL_GetWeightedCompileCount(nextShtNo);	// éüópéÜÇçló∂ÇµÇΩèdÇ›Ç√ÇØêœç⁄ñáêî(Å~0.1[ñá])
		nextShtProcSize = SRVC_GetProcessSize(nextShtNo);
		maxProcSize = SRVC_GetMaxProcessSizeCompile(sheetNo);
		if( nextShtProcSize > maxProcSize ) {									// éüópéÜÇçló∂ÇµÇΩêœç⁄ç≈ëÂópéÜí∑(Å~0.1[mm])
			maxProcSize = nextShtProcSize;
		}

		if( SRVC_GetStapleMode(sheetNo) == eCdiFinStaple_Off ) {
			ejectThresh = CMPL_GetUnStapleEjectThresh(maxProcSize, sheetNo);
		}
		else {
			ejectThresh = CMPL_GetStapleEjectThresh(sheetNo);
		}

		if( stackCount > ejectThresh ) {
			eject = SHT_EJECT_EXEC;
		}
		else {
			eject = SHT_EJECT_NOT;
		}
	}
	else {																		// îréÜêÊÇ™OutTrayà»äO
		eject = SHT_EJECT_EXEC;
	}
//	PutCMPLManagerLog(0x44,eject,stackCount,ejectThresh);
	return eject;
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetUnStapleEjectThresh
// Description   : UnStapleéwíËéûÇÃï™äÑîréÜÇÃËáílÇéÊìæ
// Parameter     : aMaxProcSize(ÉRÉìÉpÉCÉâêœç⁄ópéÜì‡Ç≈ÅAç≈ëÂÇÃópéÜëóÇËí∑)
// Return        : ï™äÑîréÜÇÃËáíl(Å~0.1[ñá])
// History 		: 
//édólïœçX(V3.6.0ÅjèåèïœçX
//ÉXÉeÅ[ÉvÉãÇ»ÇµCompileTrayStackè„å¿ñáêî(ópéÜëóÇËí∑Å@<=297mmÅï90gsmà»â∫Åj
//ÉXÉeÅ[ÉvÉãÇ»ÇµCompileTrayStackè„å¿ñáêî(ópéÜëóÇËí∑Å@ÅÑ297mmÅ@Ç‹ÇΩÅ@ópéÜëóÇËí∑Å@<=297mmÅï90gsmí¥Ç¶Åj
///////////////////////////////////////////////////////////////////
//US CMPL_GetUnStapleEjectThresh(US aMaxProcSize)
US CMPL_GetUnStapleEjectThresh(US aMaxProcSize, UC  aSheetNo)
{
	US	aEjectThresh;
	US	aMediaWeight =	SRVC_GetMediaWeight(aSheetNo); 

	//ÉXÉeÅ[ÉvÉãÇ»ÇµCompileTrayStackè„å¿ñáêî(ópéÜëóÇËí∑Å@<=297mmÅï90gsmà»â∫Åj
	if( (aMaxProcSize <= CMPL_EJECT_PROCESS_SIZE_THRESH ) &&  (aMediaWeight <= 90)) {
		aEjectThresh = (US)(SRVC_GetNvmValueUS(NVMID_MAX_COMPILE_SHEET_FOR_UNSTAPLE_SIZE_S) * 10); //100;
	}
	else {																		// 297.0[mm]í¥Ç¶
		aEjectThresh = (US)(SRVC_GetNvmValueUS(NVMID_MAX_COMPILE_SHEET_FOR_UNSTAPLE_SIZE_L) * 10); //100;
	}

	return aEjectThresh;
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetStapleEjectThresh
// Description   : StapleéwíËéûÇÃï™äÑîréÜÇÃËáílÇéÊìæ
// Parameter     : Å]
// Return        : ï™äÑîréÜÇÃËáíl(Å~0.1[ñá])
///////////////////////////////////////////////////////////////////
US CMPL_GetStapleEjectThresh(UC aSheetNo)
{
	// V3.0  ( StackerTrayîréÜStapleâ¬î\ñáêî)
		/* ópéÜÅ@1ñáìñÇΩÇËÇÃä∑éZñáêîÅ@=Å@AÅ@/Å@B
			AÅ@ÅFÅ@StaplerUnitéÌóﬁñàÇÃStapleâ¬î\ñáêî[ñá] : íPà = Å~0.1[ñá])
			BÅ@ÅFÅ@éÜéÌÅAíÿó Ç…âûÇ∂ÇΩStapleâ¬î\ñáêî[ñá]  : NVM
		*/
		US aEjectThresh;
		US	aMediaType = SRVC_GetMediaType(aSheetNo);  //
		US	aMediaWeight =	SRVC_GetMediaWeight(aSheetNo);  //
	
		US	 aWeightEjectThresh = 0; //NVM
		US	 retValue =0;
		aEjectThresh = (US)(SRVC_GetNvmValueUS(NVMID_MAX_COMPILE_SHEET_COUNT_FOR_STAPLE_50) * 10);// 65ñáÉXÉeÅ[ÉvÉâ
		//Å@îÒÉRÅ[ÉgéÜ
		if ( aMediaType != eCdiFinMediaType_Coated ) { 
	
			if ( aMediaWeight >= 60  &&  aMediaWeight <= 80 ) {  //íÿó (gsm) = 60 ~ 80
	
				aWeightEjectThresh = SRVC_GetNvmValueUS(NVMID_MAX_SHEET_UNCOAT_80_STAPLE_50);
				
			} else if ( aMediaWeight >= 81	&&	aMediaWeight <= 90 ) {	//íÿó (gsm) = 81 ~ 90
	
				aWeightEjectThresh = SRVC_GetNvmValueUS(NVMID_MAX_SHEET_UNCOAT_90_STAPLE_50);
				
			} else if ( aMediaWeight >= 91	&&	aMediaWeight <= 105 ) {  //íÿó (gsm) = 91 ~ 105 
	
				aWeightEjectThresh = SRVC_GetNvmValueUS(NVMID_MAX_SHEET_UNCOAT_105_STAPLE_50);
				
			} else if ( aMediaWeight >= 106  &&  aMediaWeight <= 128 ) {  //íÿó (gsm) = 106 ~ 128 
	
				aWeightEjectThresh = SRVC_GetNvmValueUS(NVMID_MAX_SHEET_UNCOAT_128_STAPLE_50);
				
			} else if ( aMediaWeight >= 129  &&  aMediaWeight <= 150 ) {  //íÿó (gsm) = 129 ~ 150 
	
				aWeightEjectThresh = SRVC_GetNvmValueUS(NVMID_MAX_SHEET_UNCOAT_150_STAPLE_50);
				
			} else if ( aMediaWeight >= 151  &&  aMediaWeight <= 176 ) {  //íÿó (gsm) = 151 ~ 176 
	
				aWeightEjectThresh = SRVC_GetNvmValueUS(NVMID_MAX_SHEET_UNCOAT_176_STAPLE_50);
				
			} else if ( aMediaWeight >= 177  &&  aMediaWeight <= 220 ) {  //íÿó (gsm) = 177 ~ 220 
	
				aWeightEjectThresh = SRVC_GetNvmValueUS(NVMID_MAX_SHEET_UNCOAT_220_STAPLE_50);
				
			}
			
		} else {	//Å@ÉRÅ[ÉgéÜ
	
			if ( aMediaWeight >= 106  &&  aMediaWeight <= 128 ) {  //íÿó (gsm) = 106 ~ 128
	
				aWeightEjectThresh = SRVC_GetNvmValueUS(NVMID_MAX_SHEET_COAT_128_STAPLE_50);
				
			} else if ( aMediaWeight >= 129 &&	aMediaWeight <= 150 ) {  //íÿó (gsm) = 129 ~ 150 
	
				aWeightEjectThresh = SRVC_GetNvmValueUS(NVMID_MAX_SHEET_COAT_150_STAPLE_50);
				
			} else if ( aMediaWeight >= 151 &&	aMediaWeight <= 176 ) {  //íÿó (gsm) = 151 ~ 176 
	
				aWeightEjectThresh = SRVC_GetNvmValueUS(NVMID_MAX_SHEET_COAT_176_STAPLE_50);
				
			} else if ( aMediaWeight >= 177  &&  aMediaWeight <= 220 ) {  //íÿó (gsm) = 177 ~ 220 
	
				aWeightEjectThresh = SRVC_GetNvmValueUS(NVMID_MAX_SHEET_COAT_220_STAPLE_50);
				
			}
			
		}
		
		aWeightEjectThresh = aWeightEjectThresh * (US)10;

		if ( aWeightEjectThresh != 0 ) {
			if ( aWeightEjectThresh < aEjectThresh ) {
				retValue = aWeightEjectThresh ;
			} else {
				retValue = aEjectThresh ;
			}
		} else {
			retValue = aEjectThresh ;	
		}

		return	retValue;

}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetEjectExecutionStandby
// Description   : StandbyëJà⁄éûÇ…ópéÜîrèoÇÇ∑ÇÈÇ©/ÇµÇ»Ç¢Ç©Çîªíf
// Parameter     : aSheetNo (ëŒè€ÉVÅ[ÉgÉiÉìÉoÅ[)
// Return        : SHT_EJECT_EXECÅFîrèoÇÇ∑ÇÈÅASHT_EJECT_NOTÅFîrèoÇÇµÇ»Ç¢
///////////////////////////////////////////////////////////////////
EShtEject CMPL_GetEjectExecutionStandby(UC aSheetNo)
{
	if( (SRVC_GetDestinationFinish(aSheetNo) == eCdiFinOutDest_OutTray) &&
		(SRVC_GetCoverStatus() == CVR_STTS_CLOSE) &&
		(SRVC_GetDeviceCondition(DEVID_OUT_TRAY) != DEV_COND_PERM_NG) &&
		(SRVC_GetJamZoneStatus(JAM_ZONE_ID_NUM) == JAM_ZONE_STTS_CLEAR) &&
		(SRVC_CheckSheetConditionStop(aSheetNo) == false) &&
		(SRVC_GetStapleMode(aSheetNo) == eCdiFinStaple_Off) ) {
		return SHT_EJECT_EXEC;
	}
	else {
		return SHT_EJECT_NOT;
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetWeightedCompileCount
// Description   : ëŒè€ÉVÅ[ÉgÇÃèdÇ›ñáêîÇéÊìæ
// Parameter     : aSheetNo(ëŒè€ÉVÅ[ÉgÇÃSheetNo)
// Return        : èdÇ›ñáêî(Å~0.1[ñá])
///////////////////////////////////////////////////////////////////
US CMPL_GetWeightedCompileCount(UC sheetNo)
{
	return 10;

}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetOffsetFinishPosition
// Description   : ëŒè€ÉVÅ[ÉgÇÃÉIÉtÉZÉbÉgÉtÉBÉjÉbÉVÉÖÉ|ÉWÉVÉáÉìÇéÊìæ
// Parameter     : aSheetNo(ëŒè€ÉVÅ[ÉgÇÃSheetNo)
// Return        : ëŒè€ÉVÅ[ÉgÇÃÉIÉtÉZÉbÉgÉtÉBÉjÉbÉVÉÖÉ|ÉWÉVÉáÉì
///////////////////////////////////////////////////////////////////
EShtOffsetFinish CMPL_GetOffsetFinishPosition(UC aSheetNo)
{
	UC aPrevShtNo;
	EShtOffsetFinish aPrevOfstFin, aOfstFin;

	if( SRVC_GetDestinationFinish(aSheetNo) == eCdiFinOutDest_OutTray ) {
		aPrevShtNo = SRVC_GetPrevRequestSheet(aSheetNo);

		while( aPrevShtNo != SHEETNO_NUM ) {
			if( SRVC_GetDestinationFinish(aPrevShtNo) == eCdiFinOutDest_OutTray ) {
				break;
			}
			else { /* No Action */ }

			aPrevShtNo = SRVC_GetPrevRequestSheet(aPrevShtNo);
		}

		if( aPrevShtNo != SHEETNO_NUM ) {
			aPrevOfstFin = SRVC_GetOffsetFinish(aPrevShtNo);
		}
		else {
			// aPrevOfstFin = nCmpl_Last_Offset_Position;
			aPrevOfstFin = SRVC_GetNvmValueUC(NVMID_LAST_OFFSET_POSITION);

			if( (aPrevOfstFin != SHT_OFST_FIN_LEFT) && (aPrevOfstFin != SHT_OFST_FIN_RIGHT) ) {
				aPrevOfstFin = SHT_OFST_FIN_LEFT;
			}

		}

		if( SRVC_GetSetTop(aSheetNo) == SHT_SET_TOP ) {
		
			if( SRVC_GetOffsetMode(aSheetNo) == eCdiFinOffset_Off ) {
				switch( SRVC_GetOffsetPosition(aSheetNo) ) {
				case eCdiFinOffsetPos_Left:
					aOfstFin = SHT_OFST_FIN_LEFT;
					break;
				case eCdiFinOffsetPos_Right:
					aOfstFin = SHT_OFST_FIN_RIGHT;
					break;
				default:														// eCdiFinOffsetPos_Current
				
					if( aPrevOfstFin == SHT_OFST_FIN_LEFT ) {
						aOfstFin = SHT_OFST_FIN_LEFT;
					}
					else {														// SHT_OFST_FIN_REAR
						aOfstFin = SHT_OFST_FIN_RIGHT;
					}
					break;
				}
			}
			else {
				switch( SRVC_GetOffsetPosition(aSheetNo) ) {
				case eCdiFinOffsetPos_Left:
					aOfstFin = SHT_OFST_FIN_RIGHT;
					break;
				case eCdiFinOffsetPos_Right:
					aOfstFin = SHT_OFST_FIN_LEFT;
					break;
				default:														// eCdiFinOffsetPos_Current
					if( aPrevOfstFin == SHT_OFST_FIN_LEFT ) {
						aOfstFin = SHT_OFST_FIN_RIGHT;
					}
					else {														// SHT_OFST_FIN_REAR
						aOfstFin = SHT_OFST_FIN_LEFT;
					}
					break;
				}
			}
			gCMPL_Manager.lastOffset = aOfstFin;  //(TB-)save the set-top offset info..
		}
		else {																	// SHT_SET_TOP_NOT
			aOfstFin = aPrevOfstFin;
		}
	}
	else {																		// != eCdiFinOutDest_OutTray (ä÷ó^ÇµÇ»Ç¢ÉÇÉWÉÖÅ[ÉãÇ™éwíË)
		aOfstFin = SHT_OFST_FIN_NOT;
	}

	return aOfstFin;
}


///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetCompilerSheetInitializeTimeStep1
// Description   : Sheet Initialize ìÆçÏéûä‘
// Parameter     : aSheetNo(ëŒè€ÉVÅ[ÉgÇÃSheetNo)
// Return        :  aTotalTime 
//History	 : V3.5.93 Jobèâä˙âªäJénèåèèCê≥
///////////////////////////////////////////////////////////////////
US CMPL_GetCompilerSheetInitializeTimeStep1(UC sheetNo, UC lastShtNo)
{
	US aTotalTime = 0;
	US  aPara1, aPara2, aPara3;
	US  aEjectHomeTime=0;

	gCMPL_Manager.sheetInitAction[sheetNo] = (US)0x0000;

	if( lastShtNo == SHEETNO_NUM) {	// ÉZÉbÉgécÇËÇ™ñ≥Ç¢ÉvÉçÉZÉXÉXÉ^Å[Ég Ç∆ ÉVÅ[ÉgÉCÉjÉVÉÉÉâÉCÉYìÆçÏé¿é{å„ÇÃÉLÉÉÉìÉZÉãÉPÅ[ÉXÇÉPÉA
	
		//Tamper SizePosition Times
		aPara1 = CMPL_TMP_GetSizePositioningTime(sheetNo, lastShtNo); 

		// SubPaddle HomePosition Time
		aPara2 = 229; //(V3.6.0)

		// Stacker(1621ms) > Eject Home(1147ms) ÇÃÇΩÇﬂÅAStackerìÆçÏéûä‘ÇégÇ§ÅB
		aPara3 = 1621;
		aEjectHomeTime = CMPL_GetEjectHomeNeedTime(sheetNo);

		if ( aPara3 < aEjectHomeTime){
			aPara3 = aEjectHomeTime;
		}

		aTotalTime = aPara1 + aPara2 + aPara3 ;

		gCMPL_Manager.sheetInitAction[sheetNo] |= GET_BIT_PATTERN(CMPL_MDL_ACT_EJECTOR_HOME);
		gCMPL_Manager.sheetInitAction[sheetNo] |= GET_BIT_PATTERN(CMPL_MDL_ACT_TAMP_SIZE_POS);
		gCMPL_Manager.sheetInitAction[sheetNo] |= GET_BIT_PATTERN(CMPL_MDL_ACT_PADDLE_HOME);	
		
	} else if ( (SRVC_GetSetTop(sheetNo) == SHT_SET_TOP) &&				// "êßå‰ëŒè€ópéÜÇ™ÉZÉbÉgêÊì™ópéÜÇ≈Ç†ÇËÅAà»â∫ÇÃÇ¢Ç∏ÇÍÇ©ÇÃèåèÇñûÇΩÇµÇƒÇ¢ÇÈÅA
			 ((SRVC_GetCrossProcessSize(sheetNo) != SRVC_GetCrossProcessSize(lastShtNo)) ||	//    Å®êßå‰ëŒè€ópéÜÇÃópéÜïùÇ∆êÊçséÜÇÃópéÜïùÇ™àŸÇ»ÇÈ
	 		  (SRVC_GetStapleMode(sheetNo) != SRVC_GetStapleMode(lastShtNo)) ||	//    Å®êßå‰ëŒè€ópéÜÇÃÉXÉeÅ[ÉvÉãéwíËÇ∆êÊçséÜÇÃÉXÉeÅ[ÉvÉãéwíËÇ™àŸÇ»ÇÈ
	 		  (SRVC_GetCrossProcessSizeMixSet(lastShtNo) == SHT_SIZE_MIX)) ){		//    Å®êÊçséÜÇÃÉZÉbÉgÇ…Ç®Ç¢ÇƒÉZÉbÉgì‡àŸïùÇ™î≠ê∂ÇµÇƒÇ¢ÇÈ 	
		
		//Tamper SizePosition Times
		aPara1 = CMPL_TMP_GetSizePositioningTime(sheetNo, lastShtNo); 

		aTotalTime = aPara1;
		
		gCMPL_Manager.sheetInitAction[sheetNo] |= GET_BIT_PATTERN(CMPL_MDL_ACT_TAMP_SIZE_POS);	
	}
	return aTotalTime;
}

///////////////////////////////////////////////////////////////////V3.5.93
// Function Name : CMPL_IsSheetInitExec
// Description   : äeìÆçÏÇ…Ç®ÇØÇÈÉVÅ[ÉgÉCÉjÉVÉÉÉâÉCÉYìÆçÏÇÃé¿é{îªíf
// Parameter     : sheetNo (ëŒè€ÉVÅ[ÉgÇÃÉVÅ[ÉgÉiÉìÉoÅ[)
// Return        : true ÅcÉVÅ[ÉgÉCÉjÉVÉÉÉâÉCÉYìÆçÏÇé¿é{Ç∑ÇÈ
//				 : faselÅcÉVÅ[ÉgÉCÉjÉVÉÉÉâÉCÉYìÆçÏÇé¿é{ÇµÇ»Ç¢
///////////////////////////////////////////////////////////////////
bool CMPL_IsSheetInitExec(UC aSheetNo, ECMPL_ModuleAction aAction)
{
	US aInitAction;

	
	if( (aSheetNo < SHEETNO_NUM) && (aAction < CMPL_MDL_ACT_NUM) ) {
		aInitAction = gCMPL_Manager.sheetInitAction[aSheetNo];

		if( (aInitAction & GET_BIT_PATTERN(aAction)) != 0 ) {
			return true;
		}
		else {
			return false;
		}
	}
	else {
		return false;															// à¯êîÇÃílàŸèÌ
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetEjectHomeNeedTime
// Description   : 
// Return        :  ÉCÉWÉFÉNÉg HomeìÆçÏéûä‘[ms]
///////////////////////////////////////////////////////////////////
US  CMPL_GetEjectHomeNeedTime(UC  sheetNo)
{
	return   (US)1147;
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetEjectNeedTime
// Description   : 
// Return        :  ÉCÉWÉFÉNÉgìÆçÏéûä‘[ms]
///////////////////////////////////////////////////////////////////
US  CMPL_GetEjectNeedTime(UC  sheetNo)
{
	return   (US)1167;
}


///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetBase_CompileFinishingNeedTime
// Description   : SetPitch  äÓñ{éûä‘[ms]
// Parameter     : sheetNo (êßå‰ëŒè€ÇÃÉVÅ[ÉgÉiÉìÉoÅ[)
// Return        :  a + b 
// a	ÅFCompile Exit Sensor OFFÇ©ÇÁÉ^ÉìÉsÉìÉOìÆçÏäJénÇ‹Ç≈ÇÃéûä‘[ms]
// b	ÉCÉWÉFÉNÉgìÆçÏéûä‘[ms]
// c : Compile ExitSnr On~ Off
// d : 
///////////////////////////////////////////////////////////////////
US CMPL_GetBase_CompileFinishingNeedTime(UC sheetNo)
{
	US	paraA  ;  //  a	ÅFCompile Exit Sensor OFFÇ©ÇÁÉ^ÉìÉsÉìÉOìÆçÏäJénÇ‹Ç≈ÇÃéûä‘[ms]
	US    paraB  ; //  b	ÅFÉCÉWÉFÉNÉgìÆçÏéûä‘[ms]
	US    ret;
	
	paraA = CMPL_TMP_GetEjectTampingDelayTime(sheetNo);
	paraB =   CMPL_GetEjectNeedTime(sheetNo); //1167; //1147 ;  (V3.6.2)
	ret = paraA + paraB;
	
	return  ret;	
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetAdd_CompileFinishingNeedTime
// Description   :  SetPitch â¡éZéûä‘Å@(CompilerFinishingìÆçÏéûä‘)
// Parameter     : sheetNo (êßå‰ëŒè€ÇÃÉVÅ[ÉgÉiÉìÉoÅ[)
// Return        :  A 
//A[ms] Å¶è¨êîì_à»â∫ÇÕêÿÇËéÃÇƒ
//Staple Mode Off  :  A ÅÅ a Å{ c Å{ ÇÑ
//Single Front       :  AÅÅ a Å{ b Å{ c Å{ ÇÑ
//
//éZèoéÆÇ≈égópÇµÇƒÇ¢ÇÈäeÉpÉâÉÅÅ[É^ÇÃè⁄ç◊ÇÕà»â∫ÇÃí ÇËÇ≈Ç†ÇÈÅB
//Ç»Ç®ÅAäeìÆçÏÇÃéûä‘ÇÕÇªÇÃìÆçÏÇÃé¿é{èåèÇñûÇΩÇ∑èÍçáÇÃÇ›â¡éZÇ∑ÇÈÅB
//
//a	ÅFÉ^ÉìÉsÉìÉOìÆçÏ(ÉZÉbÉgÉâÉXÉgÉ^ÉìÉsÉìÉO)éûä‘[ms] (íç:ó„é•éûä‘ä‹Çﬁ)
//b 	ÅFÉXÉeÅ[ÉvÉãìÆçÏéûä‘(ÉXÉeÅ[ÉvÉãÇë≈Ç¬éûä‘)[ms]
//c	ÅFÉ^ÉìÉpÅ[ÉIÉtÉZÉbÉgìÆçÏéûä‘[ms]
//d	ÅFÉTÉuÉpÉhÉãópéÜî¿ì¸ éûÇÃìÆçÏâÒêîÇ…ÇÊÇÈìÆçÏéûä‘[ms]
///////////////////////////////////////////////////////////////////
US CMPL_GetAdd_CompileFinishingNeedTime(UC sheetNo)
{
        US	paraA  ;  //a	ÅFÉ^ÉìÉsÉìÉOìÆçÏ(ÉZÉbÉgÉâÉXÉgÉ^ÉìÉsÉìÉO)éûä‘[ms] (íç:ó„é•éûä‘ä‹Çﬁ)
	US    paraB  ;//b 	ÅFÉXÉeÅ[ÉvÉãìÆçÏéûä‘(ÉXÉeÅ[ÉvÉãÇë≈Ç¬éûä‘)[ms]
	US    paraC  ;//c	ÅFÉ^ÉìÉpÅ[ÉIÉtÉZÉbÉgìÆçÏéûä‘[ms]
	US    paraD  ;//d	ÅFÉTÉuÉpÉhÉãópéÜî¿ì¸ éûÇÃìÆçÏâÒêîÇ…ÇÊÇÈìÆçÏéûä‘[ms]	
	US    ret;
	
	paraA =  CMPL_TMP_GetEjectTampingActionTime(sheetNo);
//    
	if ( SRVC_GetStapleMode(sheetNo) == eCdiFinStaple_Off) {
		paraB = 0;  
	}else { 
		paraB = 400;  
	}
	paraC = 180;
	paraD = CMPL_GetAdd_SubPaddleNeedTime(sheetNo);
	ret = paraA + paraB + paraC + paraD;
	
	return  ret;	
}

///////////////////////////////////////////////////////////////////
// Function Name : CShtPrepTime_Add_TamperNigasi
// Description   :  â¡éZéûä‘Å@(Tamper ì¶Ç™ÇµìÆçÏéûä‘)
// Parameter     : pThis (ÉCÉìÉXÉ^ÉìÉXÉ|ÉCÉìÉ^)
//               : sheetNo (ëŒè€ÉVÅ[ÉgÇÃÉVÅ[ÉgéØï éq)
//               : prevShtNo (êÊçsÉVÅ[ÉgÇÃÉVÅ[ÉgéØï éq)
//
// â¡éZéûä‘ :  É^ÉìÉpÅ[ì¶Ç™ÇµìÆçÏïKóvéûä‘
// â¡éZéûä‘[ms] ÅÅ a Å{ b  
//a ÅFCompile Exit Sensor OFFÇ©ÇÁÉ^ÉìÉsÉìÉOìÆçÏäJénÇ‹Ç≈ÇÃéûä‘ÅiópéÜé˚óeë“Çøéûä‘Åj[ms] 
//b ÅFÉ^ÉìÉsÉìÉOìÆçÏ(ÉmÅ[É}ÉãÉ^ÉìÉsÉìÉO)éûä‘[ms] (íç:ó„é•éûä‘ä‹Çﬁ) 
///////////////////////////////////////////////////////////////////////
US  CMPL_GetAdd_TamperOpenNeedTime(UC  sheetNo)
{
	US   ret;
	US   paraA;
	US   paraB;
		
	if ( CMPL_GetActionModeTamperOpen(sheetNo)) {  //É^ÉìÉpÅ[ÉIÅ[ÉvÉììÆçÏÇé¿é{Ç∑ÇÈ
		paraA = CMPL_TMP_GetNormalTampingDelayTime(sheetNo);
		paraB = CMPL_TMP_GetNormalTampingActionTime(sheetNo);
		ret = paraA + paraB;
	} else {
		ret=0;
	}
	return  ret;
}

///////////////////////////////////////////////////////////////////
// Function Name : CShtPrepTime_Add_SubPaddleTimes
// Description   :  â¡éZéûä‘Å@(SubPaddle 3âÒà»è„ÇÃèÍçá, ìÆçÏéûä‘)
// Parameter     : pThis (ÉCÉìÉXÉ^ÉìÉXÉ|ÉCÉìÉ^)
//               : sheetNo (ëŒè€ÉVÅ[ÉgÇÃÉVÅ[ÉgéØï éq)
//               : prevShtNo (êÊçsÉVÅ[ÉgÇÃÉVÅ[ÉgéØï éq)
// â¡éZéûä‘ :  ÉTÉuÉpÉhÉãópéÜî¿ì¸ éûÇÃìÆçÏâÒêîÇ™3âÒÇÃèÍçáÇÃâ¡éZéûä‘     
//
//â¡éZéûä‘ÅÅ(PâÒ-2)Å~tms
//ÇîmsÅÅ360 Å~äeÉTÉuÉpÉhÉãópéÜî¿ì¸ ÉvÉçÉtÉ@ÉCÉãÇÃ30STEPéûÇÃé¿çséûä‘ÅÄ1.722
//Å¶13.767ÇÕT1 PULSEéûÇÃâÒì]äpìx
//     íAÇµÅAåvéZåãâ Ç™É}ÉCÉiÉXÇ≈Ç†ÇÍÇŒ0msÇ…Ç∑ÇÈ
///////////////////////////////////////////////////////////////////////
US  CMPL_GetAdd_SubPaddleNeedTime(UC sheetNo)
{
	UC    paddleCnt; 
	US    aTotalTime, aTemp;
	
	paddleCnt =  CMPL_EJCT_GetSubPaddleActionCount(sheetNo);

	if ( paddleCnt >= 3 )  { // 
		aTemp = (US)paddleCnt;   //
		aTotalTime = (US)((aTemp - 2) * 150);  // (PâÒ - 2) * tms ..

	} else {
		aTotalTime = 0;
	}
	
//	PutCMPLManagerLog(0x56,0x56, paddleCnt,aTotalTime);
	return aTotalTime;
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_GetActionModeTamperOpen
// Description   : É^ÉìÉpÅ[ÉIÅ[ÉvÉììÆçÏÇÃé¿é{óLñ≥ÇéÊìæ
// Parameter     : sheetNo (ëŒè€ÉVÅ[ÉgÇÃÉVÅ[ÉgÉiÉìÉoÅ[)
// Return        : É^ÉìÉpÅ[ÉIÅ[ÉvÉììÆçÏÇÃé¿é{óLñ≥
//				 : îÕàÕÅF0Å`1
//				 : à”ñ°ÅF0ÅcÉ^ÉìÉpÅ[ÉIÅ[ÉvÉììÆçÏÇé¿é{ÇµÇ»Ç¢
//				 : 		 1ÅcÉ^ÉìÉpÅ[ÉIÅ[ÉvÉììÆçÏÇé¿é{Ç∑ÇÈ
///////////////////////////////////////////////////////////////////
UC CMPL_GetActionModeTamperOpen(UC sheetNo)
{
	if( CMPL_TMP_IsOpenExec(sheetNo) == true ) {
		return 1;
	}
	else {
		return 0;
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_DownCompCheck
// Description   : ÉtÉBÉjÉbÉVÉìÉOÉvÉçÉZÉXèàóùäÆóπÉ`ÉFÉbÉN
// Parameter     : Å]
// Return        : trueÅFäÆóπÅAfalseÅFñ¢óπ
///////////////////////////////////////////////////////////////////
bool CMPL_DownCompCheck()
{
	UC aIndex;

	if( (gCMPL_Manager.state == CMPL_STT_CYCLE_DOWN) || (gCMPL_Manager.state == CMPL_STT_HARD_DOWN) ) {
		
		for( aIndex = 0; aIndex < CMPL_SHTMNGNUM; aIndex++ ) {
			if( gCMPL_Manager.seqMngInfo[aIndex].sheetNo != SHEETNO_NUM ) {
				break;
			}
		}

		if( (aIndex >= CMPL_SHTMNGNUM) &&
			(CMPL_EJCT_IsExecutingModuleAction() == false) &&
			(CMPL_STPL_IsExecutingModuleAction() == false) &&
			(CMPL_TMP_IsExecutingModuleAction() == false) ) {
			if( (gCMPL_Manager.finishingWaitSheet == SHEETNO_NUM) &&
			    ( SRVC_CheckUndeliveredSheetExist(eCdiFinOutDest_OutTray) == false ) ){

				PutCMPLManagerLog(0x26, gCMPL_Manager.finishingWaitSheet , 
				 (US)aIndex, (US)SRVC_CheckUndeliveredSheetExist(eCdiFinOutDest_OutTray) );
				return true;
			}
			else {
				/* No Action */
				PutCMPLManagerLog(0x24, gCMPL_Manager.finishingWaitSheet , 
				 (US)aIndex, (US)SRVC_CheckUndeliveredSheetExist(eCdiFinOutDest_OutTray) );
			}
		}
		else {
			PutCMPLManagerLog(0x23, (UC)CMPL_EJCT_IsExecutingModuleAction() , (US)aIndex, (US)gCMPL_Manager.finishingWaitSheet);
			/* No Action */
		}
	}
	else {
		/* No Action */		
	}

	return false;
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_CheckEjectPossible
// Description   : ópéÜîrèoÇ™Ç≈Ç´ÇÈÇ©ÇÃîªíf
// Parameter     : Å]
// Return        : trueÅFîrèoâ¬ÅAfalseÅFîrèoïsâ¬
///////////////////////////////////////////////////////////////////
bool CMPL_CheckEjectPossible()
{
	if( (SRVC_GetCoverStatus() == CVR_STTS_CLOSE) &&
		(SRVC_GetJamZoneStatus(JAM_ZONE_ID_NUM) == JAM_ZONE_STTS_CLEAR) ) {
		return true;
	}
	else {
		return false;
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ClearSequenceManageInfo
// Description   : Sequence Manage InfoÉNÉäÉA
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ClearSequenceManageInfo(UC aIndex)
{
	gCMPL_Manager.seqMngInfo[aIndex].sequenceId = CMPL_SEQ_ID_NUM;
	gCMPL_Manager.seqMngInfo[aIndex].actionLog  = 0x0000;
	gCMPL_Manager.seqMngInfo[aIndex].sheetNo    = SHEETNO_NUM;	
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_PowerOnInit
// Description   : Power On InitializeìÆçÏ(äJén/í‚é~)
// Parameter     : aAction (ìÆçÏÇÃäJén/í‚é~)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_PowerOnInit(EAction aAction)
{
	if( aAction == ACT_START )	CMPL_StartPowerOnInit();
	else					 	CMPL_StopPowerOnInit();							// Stop
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StartPowerOnInit
// Description   : Power On InitializeìÆçÏäJén
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StartPowerOnInit()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_NUM ) {
		gCMPL_Manager.seqMngInfo[0].sequenceId = CMPL_SEQ_ID_POWER_ON_INIT;
		gCMPL_Manager.seqMngInfo[0].actionLog = 0x0000;
		gCMPL_Manager.seqMngInfo[0].sheetNo = SHEETNO_NUM;	
		
		gCMPL_Manager.lastStaSeqIndex = 0;
		
		if( SRVC_GetDeviceCondition(DEVID_FINISHER) != DEV_COND_PERM_NG ) {
			CMPL_ExecuteSequence(CMPL_MDL_ACT_START, 0);
		}
		else {
			CMPL_CompletePowerOnInit();
		}
	}
	else {
		/* Irregular Case */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_CompletePowerOnInit
// Description   : Power On InitializeìÆçÏäÆóπ
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_CompletePowerOnInit()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_POWER_ON_INIT ) {
		CMPL_ClearSequenceManageInfo(0);
		MSP_SendMessage(MID_CMPL, EVT_DEV_RES_POWER_ON_INIT_CMPL, 0, 0, LOG_OFF);
	}
	else {
		/* Irregular Case */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StopPowerOnInit
// Description   : Power On InitializeìÆçÏí‚é~
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StopPowerOnInit()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_POWER_ON_INIT ) {
		CMPL_EJCT_StopModuleAction();
		CMPL_STPL_StopModuleAction();
		CMPL_TMP_StopModuleAction();

		CMPL_CompletePowerOnInit();
	}
	else {
		/* Irregular Case */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ResumeInit
// Description   : Resume InitializeìÆçÏ(äJén/í‚é~)
// Parameter     : aAction (ìÆçÏÇÃäJén/í‚é~)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ResumeInit(EAction aAction)
{
	if( aAction == ACT_START )	CMPL_StartResumeInit();
	else					 	CMPL_StopResumeInit();							// Stop
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StartPowerResumeInit
// Description   : Resume InitializeìÆçÏäJén
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StartResumeInit()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_NUM ) {
		gCMPL_Manager.seqMngInfo[0].sequenceId = CMPL_SEQ_ID_RESUME_INIT;
		gCMPL_Manager.seqMngInfo[0].actionLog = 0x0000;
		gCMPL_Manager.seqMngInfo[0].sheetNo = SHEETNO_NUM;
		
		gCMPL_Manager.lastStaSeqIndex = 0;
		
		if( SRVC_GetDeviceCondition(DEVID_FINISHER) != DEV_COND_PERM_NG ) {
			CMPL_ExecuteSequence(CMPL_MDL_ACT_START, 0);
		}
		else {
			CMPL_CompleteResumeInit();
		}
	}
	else {
		/* Irregular Case */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_CompleteResumeInit
// Description   : Resume InitializeìÆçÏäÆóπ
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_CompleteResumeInit()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_RESUME_INIT ) {
		CMPL_ClearSequenceManageInfo(0);
		MSP_SendMessage(MID_CMPL, EVT_DEV_RES_RESUME_INIT_CMPL, 0, 0, LOG_OFF);
	}
	else {
		/* Irregular Case */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StopResumeInit
// Description   : Resume InitializeìÆçÏí‚é~
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StopResumeInit()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_RESUME_INIT ) {
		CMPL_EJCT_StopModuleAction();
		CMPL_STPL_StopModuleAction();
		CMPL_TMP_StopModuleAction();

		CMPL_CompleteResumeInit();
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_NormalInit
// Description   : ÉmÅ[É}ÉãÉCÉjÉVÉÉÉâÉCÉYìÆçÏ(äJén/í‚é~)
// Parameter     : aAction (äJén/í‚é~)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_NormalInit(EAction aAction)
{
	if( aAction == ACT_START )	CMPL_StartNormalInit();
	else						CMPL_StopNormalInit();
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StartNormalInit
// Description   : ÉmÅ[É}ÉãÉCÉjÉVÉÉÉâÉCÉYìÆçÏäJén
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StartNormalInit()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_NUM ) {
		gCMPL_Manager.seqMngInfo[0].sequenceId = CMPL_SEQ_ID_NORMAL_INIT;
		gCMPL_Manager.seqMngInfo[0].actionLog = 0x0000;
		gCMPL_Manager.seqMngInfo[0].sheetNo = SHEETNO_NUM;

		gCMPL_Manager.lastStaSeqIndex = 0;

		if( SRVC_GetDeviceCondition(DEVID_FINISHER) != DEV_COND_PERM_NG ) {
			CMPL_ExecuteSequence(CMPL_MDL_ACT_START, 0);
		}
		else {
			CMPL_CompleteNormalInit();
		}
	}
	else {
		/* Irregular Case */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_CompleteNormalInit
// Description   : ÉmÅ[É}ÉãÉCÉjÉVÉÉÉâÉCÉYìÆçÏäÆóπ
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_CompleteNormalInit()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_NORMAL_INIT ) {
		CMPL_ClearSequenceManageInfo(0);

		MSP_SendMessage(MID_CMPL, EVT_DEV_RES_NORMAL_INIT_CMPL, 0, 0, LOG_OFF);
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StopNormalInit
// Description   : ÉmÅ[É}ÉãÉCÉjÉVÉÉÉâÉCÉYìÆçÏí‚é~
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StopNormalInit()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_NORMAL_INIT ) {
		CMPL_EJCT_StopModuleAction();
		CMPL_STPL_StopModuleAction();
		CMPL_TMP_StopModuleAction();

		CMPL_CompleteNormalInit();
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_SheetInitialize
// Description   : ÉVÅ[ÉgÉCÉjÉVÉÉÉâÉCÉYìÆçÏ(äJén/í‚é~)
// Parameter     : aSheetNo(éwíËSheet No.)
//				 : aAction(ìÆçÏéwé¶(äJén/í‚é~))
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_SheetInitialize(UC aSheetNo, EAction aAction)
{
	if( aAction == ACT_START ) {
		CMPL_StartSheetInitialize(aSheetNo);
	}
	else {																		// ACT_STOP
		CMPL_StopSheetInitialize(aSheetNo);

 		if( CMPL_DownCompCheck() == true ) {
			CMPL_ChangeProcDownEvent();
		}
		else {
			/* No Action */
		}
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StartSheetInitialize
// Description   : ÉVÅ[ÉgÉCÉjÉVÉÉÉâÉCÉYìÆçÏäJén
// Parameter     : aSheetNo(éwíËSheet No.)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StartSheetInitialize(UC aSheetNo)
{
	UC aIndex;

	aIndex = (UC)((gCMPL_Manager.lastStaSeqIndex + 1) & (CMPL_SHTMNGNUM - 1));

	if( gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_NUM ) {
		gCMPL_Manager.seqMngInfo[aIndex].sequenceId = CMPL_SEQ_ID_SHEET_INIT;
		gCMPL_Manager.seqMngInfo[aIndex].actionLog = 0x0000;
		gCMPL_Manager.seqMngInfo[aIndex].sheetNo = aSheetNo;

		gCMPL_Manager.lastStaSeqIndex = aIndex;
		gCMPL_Manager.finishingWaitSheet = SHEETNO_NUM;
		
		if( (SRVC_CheckSheetConditionNormal(aSheetNo) == true) &&
			(SRVC_GetDeviceCondition(DEVID_FINISHER) != DEV_COND_PERM_NG) ) {
			
			CMPL_ExecuteSequence(CMPL_MDL_ACT_START, aIndex);
		}
		else {
			CMPL_CompleteSheetInitialize(aIndex);
		}
	}
	else {
		/* Irregular Case */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_CompleteSheetInitialize
// Description   : ÉVÅ[ÉgÉCÉjÉVÉÉÉâÉCÉYìÆçÏäÆóπ
// Parameter     : aIndex(ÉVÅ[ÉPÉìÉXä«óùî‘çÜ)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_CompleteSheetInitialize(UC aIndex)
{
	EvtParamSheetActionResponse aMessage;
	UC aSheetNo;

	if( gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_SHEET_INIT ) {
		aSheetNo = gCMPL_Manager.seqMngInfo[aIndex].sheetNo;

		CMPL_ClearSequenceManageInfo(aIndex);

		aMessage.sheetNo = aSheetNo;
		MSP_SendMessage(MID_CMPL, EVT_SHT_RES_COMPILER_SHT_INIT_CMPL, (UC*)(&aMessage), sizeof(aMessage), LOG_OFF);
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StopSheetInitialize
// Description   : ÉVÅ[ÉgÉCÉjÉVÉÉÉâÉCÉYìÆçÏí‚é~
// Parameter     : aIndex(ÉVÅ[ÉPÉìÉXä«óùî‘çÜ)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StopSheetInitialize(UC aSheetNo)
{
	UC aIndex;

	for( aIndex = 0; aIndex < CMPL_SHTMNGNUM; aIndex++ ) {
		if( gCMPL_Manager.seqMngInfo[aIndex].sheetNo == aSheetNo ) {
			if( gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_SHEET_INIT ) {
				CMPL_EJCT_StopSheet(aSheetNo);
				CMPL_STPL_StopSheet(aSheetNo);
				CMPL_TMP_StopSheet(aSheetNo);

				CMPL_CompleteSheetInitialize(aIndex);
			}
			else {
				/* No Action */
			}
		}
		else {
			/* No Action */
		}
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ProcessEnd
// Description   : ÉvÉçÉZÉXÉGÉìÉhìÆçÏ(äJén/í‚é~)
// Parameter     : aAction(ìÆçÏéwé¶(äJén/í‚é~))
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ProcessEnd(EAction aAction)
{
	if( aAction == ACT_START )	CMPL_StartProcessEnd();
	else						CMPL_StopProcessEnd();							// ACT_STOP
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StartProcessEnd
// Description   : ÉvÉçÉZÉXÉGÉìÉhìÆçÏäJén
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StartProcessEnd()
{

       if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_NUM ) {

		gCMPL_Manager.seqMngInfo[0].sequenceId = CMPL_SEQ_ID_PROC_END;
		gCMPL_Manager.seqMngInfo[0].actionLog = 0x0000;
		gCMPL_Manager.seqMngInfo[0].sheetNo = SHEETNO_NUM;

		gCMPL_Manager.lastStaSeqIndex = 0;

		//V3.1.7  StapleCoverILK OpenéûÇÕÅAìÆçÏÇµÇ»Ç¢
		if (SRVC_GetCoverStatus_ID(CVR_ID_FIN_STAPLE_ILK) == CVR_STTS_OPEN) {
			CMPL_CompleteProcessEnd();
		} else { 
			CMPL_ExecuteSequence(CMPL_MDL_ACT_START, 0);
		}
		SRVC_UserDebugLog(0x50, 0x50);
	}
	else {
		/* Irregular Case */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_CompleteProcessEnd
// Description   : ÉvÉçÉZÉXÉGÉìÉhìÆçÏäÆóπ
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_CompleteProcessEnd()
{
			
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_PROC_END ) {

		SRVC_UserDebugLog(0x51, 0x51);
		CMPL_ClearSequenceManageInfo(0);
		MSP_SendMessage(MID_CMPL, EVT_DEV_RES_PROCESS_END_CMPL, 0, 0, LOG_OFF);
		
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StopProcessEnd
// Description   : ÉvÉçÉZÉXÉGÉìÉhìÆçÏí‚é~
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StopProcessEnd()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_PROC_END ) {
		CMPL_EJCT_StopModuleAction();
		CMPL_STPL_StopModuleAction();
		CMPL_TMP_StopModuleAction();

		CMPL_CompleteProcessEnd();
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_JamClearAssist
// Description   : ÉWÉÉÉÄÉNÉäÉAï‚èïÉCÉjÉVÉÉÉâÉCÉYìÆçÏ(äJén/í‚é~)
// Parameter     : aAction(ìÆçÏéwé¶(äJén/í‚é~))
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_JamClearAssist(EAction aAction)
{
	if( aAction == ACT_START )	CMPL_StartJamClearAssist();
	else					 	CMPL_StopJamClearAssist();						// ACT_STOP
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StartJamClearAssist
// Description   : ÉWÉÉÉÄÉNÉäÉAï‚èïÉCÉjÉVÉÉÉâÉCÉYìÆçÏäJén
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StartJamClearAssist()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_NUM ) {
		gCMPL_Manager.seqMngInfo[0].sequenceId = CMPL_SEQ_ID_JAM_CLEAR_ASSIST;
		gCMPL_Manager.seqMngInfo[0].actionLog = 0x0000;
		gCMPL_Manager.seqMngInfo[0].sheetNo = SHEETNO_NUM;

		gCMPL_Manager.lastStaSeqIndex = 0;

		CMPL_ExecuteSequence(CMPL_MDL_ACT_START, 0);
	}
	else {
		/* Irregular Case */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_CompleteJamClearAssist
// Description   : ÉWÉÉÉÄÉNÉäÉAï‚èïÉCÉjÉVÉÉÉâÉCÉYìÆçÏäÆóπ
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_CompleteJamClearAssist()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_JAM_CLEAR_ASSIST ) {
		CMPL_ClearSequenceManageInfo(0);

		MSP_SendMessage(MID_CMPL, EVT_DEV_RES_JAM_CLEAR_ASSIST_CMPL, 0, 0, LOG_OFF);
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StopJamClearAssist
// Description   : ÉWÉÉÉÄÉNÉäÉAï‚èïÉCÉjÉVÉÉÉâÉCÉYìÆçÏí‚é~
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StopJamClearAssist()
{
	if( gCMPL_Manager.seqMngInfo[0].sequenceId == CMPL_SEQ_ID_JAM_CLEAR_ASSIST ) {
		CMPL_EJCT_StopModuleAction();
		CMPL_STPL_StopModuleAction();
		CMPL_TMP_StopModuleAction();

		CMPL_CompleteJamClearAssist();
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_CompilerAction
// Description   : ÉRÉìÉpÉCÉâÉAÉNÉVÉáÉììÆçÏ(äJén/í‚é~)
// Parameter     : aSheetNo(éwíËSheet No.)
//				 : aAction(ìÆçÏéwé¶(äJén/í‚é~))
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_CompilerAction(UC aSheetNo, EAction aAction)
{
	if( aAction == ACT_START ) {
	CMPL_StartCompilerAction(aSheetNo);
	//CMPL_TMP_NormalTamping(aSheetNo);
	}
	else {																		// ACT_STOP
	 	CMPL_StopCompilerAction(aSheetNo);
 
 		if( CMPL_DownCompCheck() == true ) {
			CMPL_ChangeProcDownEvent();
		}
		else {
			/* No Action */
		}
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StartCompilerAction
// Description   : ÉRÉìÉpÉCÉâÉAÉNÉVÉáÉììÆçÏäJén
// Parameter     : aSheetNo(éwíËSheet No.)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StartCompilerAction(UC aSheetNo)
{
	UC aIndex;
	EShtEject aEject = SRVC_GetEject(aSheetNo);
	ECMPL_SequenceId aSeqId;
	EvtParamSheetEventNotify aMessage;

	if( gCMPL_Manager.state == CMPL_STT_STANDBY ) {
		aIndex = 0;
		aSeqId = CMPL_SEQ_ID_STANDBY_EJECT_FINISHING;
	}
	else {
		aIndex = (UC)((gCMPL_Manager.lastStaSeqIndex + 1) & (CMPL_SHTMNGNUM - 1));
		if( aEject == SHT_EJECT_EXEC ) {
			aSeqId = CMPL_SEQ_ID_EJECT_FINISHING;
		}
		else {
			aSeqId = CMPL_SEQ_ID_COMPILE_FINISHING;
		}
	}

	if( SRVC_CheckSheetConditionNormal(aSheetNo) == true ) {						// LeaveópéÜÇ™îréÜëŒè€Ç∆Ç»Ç¡ÇΩèÍçáÇÕÅAConditionÇ™RemainÇ…èëÇ´ä∑ÇÌÇÈÇΩÇﬂÅA
		if( gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_NUM ) {	// ConditionNormalÇÃÉ`ÉFÉbÉNÇ≈OKÇ∆ÇµÇƒÇ¢ÇÈ
			if( aEject == SHT_EJECT_EXEC ) {
				gCMPL_Manager.compileSheet = SHEETNO_NUM;

				aMessage.sheetNo = aSheetNo;
				MSP_SendMessage(MID_CMPL, EVT_SHT_EVT_OUT_TRAY_EJECT_FINISH_START, (UC*)(&aMessage), sizeof(aMessage), LOG_OFF);
			}

			gCMPL_Manager.seqMngInfo[aIndex].sequenceId = aSeqId;
			gCMPL_Manager.seqMngInfo[aIndex].actionLog = 0x0000;
			gCMPL_Manager.seqMngInfo[aIndex].sheetNo = aSheetNo;

			gCMPL_Manager.lastStaSeqIndex = aIndex;

			if( SRVC_GetDeviceCondition(DEVID_FINISHER) != DEV_COND_PERM_NG ) {
				if( aSeqId == CMPL_SEQ_ID_STANDBY_EJECT_FINISHING ) {
					CMPL_EJCT_StandbyEjectStartNotify();
					CMPL_STPL_StandbyEjectStartNotify();
					CMPL_TMP_StandbyEjectStartNotify();
				}
				CMPL_ExecuteSequence(CMPL_MDL_ACT_START, aIndex);
			}
			else {
				CMPL_CompleteCompilerAction(aIndex);
			}
		}
		else {
			/* Irregular Case */
		}
	}
	else {
		//V3.6.93  EjectFail -> CompileSNR OFF éûÅACondition=NGÇ∆ÇµÇƒèàóùÇ≥ÇÍÇ»Ç¢ÇΩÇﬂÅAStandbyÇ…çsÇ©Ç»Ç¢ïsãÔçá
		if( CMPL_DownCompCheck() == true ) {
			CMPL_ChangeProcDownEvent();
		}
		else {
			/* No Action */
		}
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_CompleteCompilerAction
// Description   : ÉRÉìÉpÉCÉâÉAÉNÉVÉáÉììÆçÏäÆóπ
// Parameter     : aIndex(Sequence Index)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_CompleteCompilerAction(UC aIndex)
{
	UC aSheetNo;
	US aEventId;
	EvtParamSheetEventNotify aMessage;
	
	if( (gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_COMPILE_FINISHING)	||
		(gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_EJECT_FINISHING) 	||
		(gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_STANDBY_EJECT_FINISHING) ) {
		aSheetNo = gCMPL_Manager.seqMngInfo[aIndex].sheetNo;							// ÉÅÉbÉZÅ[ÉWëóêMópÇ…ï€éù

		if( gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_COMPILE_FINISHING ) {
			gCMPL_Manager.compileSheet = gCMPL_Manager.seqMngInfo[aIndex].sheetNo;

			CMPL_ClearSequenceManageInfo(aIndex);

			aMessage.sheetNo = aSheetNo;
			MSP_SendMessage(MID_CMPL, EVT_SHT_EVT_OUT_TRAY_COMPILE_FINISH_COMP, (UC*)(&aMessage), sizeof(aMessage), LOG_OFF);

			if( SRVC_GetEject(aSheetNo) == SHT_EJECT_EXEC ) {	// ÉRÉìÉpÉCÉãÉtÉBÉjÉbÉVÉìÉOíÜÇ…îrèoëŒè€Ç∆Ç»Ç¡ÇΩÉPÅ[ÉX
				CMPL_StartCompilerAction(aSheetNo);
			}
		}
		else {																	// CMPL_SEQ_ID_EJECT_FINISHING, CMPL_SEQ_ID_STANDBY_EJECT_FINISHING
			if( gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_STANDBY_EJECT_FINISHING ) {
				CMPL_EJCT_StandbyEjectCompNotify;									// StandbyEjectFinishing
				CMPL_STPL_StandbyEjectCompNotify;
				CMPL_TMP_StandbyEjectCompNotify();
			}

			//(TB- )SetTopÇÃOffsetèÓïÒÇ™NVMÇ…ê≥ÇµÇ≠èëÇ¢ÇƒÇ¢Ç»Ç¢
			//SRVC_SetNvmValueUC(CMPL_GetOffsetFinishPosition(gCMPL_Manager.seqMngInfo[aIndex].sheetNo), NVMID_LAST_OFFSET_POSITION);
			SRVC_SetNvmValueUC(gCMPL_Manager.lastOffset , NVMID_LAST_OFFSET_POSITION);
						
			CMPL_ClearSequenceManageInfo(aIndex);

			aMessage.sheetNo = aSheetNo;
			MSP_SendMessage(MID_CMPL, EVT_SHT_EVT_OUT_TRAY_EJECT_FINISH_COMP, (UC*)(&aMessage), sizeof(aMessage), LOG_OFF);
		}

	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_StopCompilerAction
// Description   : ÉRÉìÉpÉCÉâÉAÉNÉVÉáÉììÆçÏí‚é~
// Parameter     : aIndex(Sequence Index)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_StopCompilerAction(UC aSheetNo)
{
	UC aIndex;

	for( aIndex = 0; aIndex < CMPL_SHTMNGNUM; aIndex++ ) {
		if( gCMPL_Manager.seqMngInfo[aIndex].sheetNo == aSheetNo ) {
			if( (gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_COMPILE_FINISHING) ||
				(gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_EJECT_FINISHING) ||
				(gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_STANDBY_EJECT_FINISHING) ) {
				CMPL_EJCT_StopSheet(aSheetNo);
				CMPL_STPL_StopSheet(aSheetNo);
				CMPL_TMP_StopSheet(aSheetNo);

				CMPL_CompleteCompilerAction(aIndex);
			}
			else {
				/* No Action */
			}
		}
		else {
			/* No Action*/
		}
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ExecuteSequence
// Description   : ÉVÅ[ÉPÉìÉXêßå‰é¿çs
// Parameter     : aCompAct (ìÆçÏäÆóπÇµÇΩìÆçÏ)
//				 : aSeqMngIdx (SequenceManageInfoÇÃIndex)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ExecuteSequence(ECMPL_ModuleAction aCompAct, UC aSeqMngIdx)
{
	UL aNextAct;
	UC aActIdx, aSheetNo, aMdlActIdx, aMdlActRslt;
	const SCMPL_MdlActSeq* apMdlActSeq;

	apMdlActSeq = cCMPL_ModuleActionSequence[gCMPL_Manager.seqMngInfo[aSeqMngIdx].sequenceId];
	PutCMPLManagerLog(0x30,  aSeqMngIdx, 
		(US)gCMPL_Manager.seqMngInfo[aSeqMngIdx].sequenceId, (US)gCMPL_Manager.seqMngInfo[aSeqMngIdx].sheetNo );

	for( aActIdx = 0; apMdlActSeq[aActIdx].actID != CMPL_MDL_ACT_END; aActIdx++) {

		if( apMdlActSeq[aActIdx].actID == aCompAct ) {
			gCMPL_Manager.seqMngInfo[aSeqMngIdx].actionLog |= GET_BIT_PATTERN(aCompAct);

			if( (apMdlActSeq[aActIdx].condBit & gCMPL_Manager.seqMngInfo[aSeqMngIdx].actionLog) == apMdlActSeq[aActIdx].condBit ) {
				if( apMdlActSeq[aActIdx].nextBit != CMPLMDLACTBIT_END ) {
					aSheetNo = gCMPL_Manager.seqMngInfo[aSeqMngIdx].sheetNo;
					aNextAct = apMdlActSeq[aActIdx].nextBit;

					for( aMdlActIdx = 0; aMdlActIdx < CMPL_MDL_ACT_NUM; aMdlActIdx++ ) {
						if( aNextAct != 0) {
							if( (aNextAct & 1) != 0 ) {
								switch( aMdlActIdx ) {
								//case CMPL_MDL_ACT_EXIT_ROLL_RELEASE_WAIT:	CMPL_ExitRollReleaseWait(aSheetNo);	break;
								case CMPL_MDL_ACT_CURRENT_OFF:				CMPL_CurrentOFF(aSheetNo);			break;
								case CMPL_MDL_ACT_TAMP_MISS_REGI:			CMPL_TMP_MissRegi(aSheetNo);		break;
								case CMPL_MDL_ACT_STAPLE_HEAD_HOME:		CMPL_STPL_StapleHeadHome(aSheetNo);	break;
								case CMPL_MDL_ACT_EJECTOR_HOME:			CMPL_EJCT_EjectorHome(aSheetNo);	break;
								case CMPL_MDL_ACT_STAPLE_HARIOUT:			CMPL_STPL_StapleHeadHariout(aSheetNo); break;
								case CMPL_MDL_ACT_PADDLE_HOME:                  	CMPL_EJCT_PaddleHome(aSheetNo);	break;
								case CMPL_MDL_ACT_PADDLE_COMPILE:			CMPL_EJCT_PaddleCompile(aSheetNo);	break;
								case CMPL_MDL_ACT_TAMP_SIZE_POS:			CMPL_TMP_SizePositioning(aSheetNo);	break;
								case CMPL_MDL_ACT_NORMAL_TAMPING:			CMPL_TMP_NormalTamping(aSheetNo);	break;
								case CMPL_MDL_ACT_EJECT_TAMPING:			CMPL_TMP_EjectTamping(aSheetNo);	break;
								case CMPL_MDL_ACT_STAPLE:					CMPL_STPL_Staple(aSheetNo);			break;
								case CMPL_MDL_ACT_OFFSET:					CMPL_TMP_Offset(aSheetNo);			break;
								case CMPL_MDL_ACT_RETURN:					CMPL_TMP_Return(aSheetNo);			break;
								case CMPL_MDL_ACT_EJECT:					CMPL_EJCT_Eject(aSheetNo);			break;
								default:																			break;
								}
							}
							else { /* Go for loop */ }

							aNextAct >>= 1;
						}
						else {
							break;												// Next action none
						}
					}
				}
				else {

					PutCMPLManagerLog(0x31,  aSeqMngIdx, 
							(US)gCMPL_Manager.seqMngInfo[aSeqMngIdx].sequenceId, (US)gCMPL_Manager.seqMngInfo[aSeqMngIdx].sheetNo );
						
					switch( gCMPL_Manager.seqMngInfo[aSeqMngIdx].sequenceId ) {
					case CMPL_SEQ_ID_POWER_ON_INIT:				CMPL_CompletePowerOnInit();					break;
					case CMPL_SEQ_ID_RESUME_INIT:				CMPL_CompleteResumeInit();					break;
					case CMPL_SEQ_ID_NORMAL_INIT:				CMPL_CompleteNormalInit();					break;
					case CMPL_SEQ_ID_SHEET_INIT:				CMPL_CompleteSheetInitialize(aSeqMngIdx);	break;
					case CMPL_SEQ_ID_COMPILE_FINISHING:			CMPL_CompleteCompilerAction(aSeqMngIdx);	break;
					case CMPL_SEQ_ID_EJECT_FINISHING:			CMPL_CompleteCompilerAction(aSeqMngIdx);	break;
					case CMPL_SEQ_ID_STANDBY_EJECT_FINISHING:	CMPL_CompleteCompilerAction(aSeqMngIdx);	break;
					case CMPL_SEQ_ID_PROC_END:					CMPL_CompleteProcessEnd();					break;
					case CMPL_SEQ_ID_JAM_CLEAR_ASSIST:			CMPL_CompleteJamClearAssist();				break;
					default:									/* Irregular Case */						break;
					}
				}
			}
			else { /* Wait another action complete */ }

			break;
		}
		else { /* No action */ }
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_InformedModuleActionComp
// Description   : Module Action Complete(Compiler Internal I/F)í íméÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_InformedModuleActionComp(ECMPL_ModuleAction aAction, UC aSheetNo)
{
	UC aIndex = (UC)((gCMPL_Manager.lastStaSeqIndex + 1) & (CMPL_SHTMNGNUM - 1));
	UC aLoopCnt, aActIdx;
	const SCMPL_MdlActSeq* apMdlActSeq;

	if( aSheetNo != SHEETNO_NUM ) {
		for( aLoopCnt = 0; aLoopCnt < CMPL_SHTMNGNUM; aLoopCnt++ ) {
			if( (gCMPL_Manager.seqMngInfo[aIndex].sheetNo == aSheetNo) && (gCMPL_Manager.seqMngInfo[aIndex].sequenceId != CMPL_SEQ_ID_NUM) ) {
				apMdlActSeq = cCMPL_ModuleActionSequence[gCMPL_Manager.seqMngInfo[aIndex].sequenceId];

				for( aActIdx = 0; apMdlActSeq[aActIdx].actID != CMPL_MDL_ACT_END; aActIdx++ ) {
					if( (apMdlActSeq[aActIdx].actID == aAction) &&				// aActionÇ™ÉVÅ[ÉPÉìÉXì‡Ç…Ç†ÇÈÇ©ÅAÇ∑Ç≈Ç…äÆóπÇµÇƒÇ¢Ç»Ç¢Ç©ÇÉ`ÉFÉbÉN
						((gCMPL_Manager.seqMngInfo[aIndex].actionLog & GET_BIT_PATTERN(aAction)) == 0) ) {
						aLoopCnt = CMPL_SHTMNGNUM;
						CMPL_ExecuteSequence(aAction, aIndex);

						break;
					}
					else { /* No Action */ }
				}
			}
			else { /* No Action */ }

			aIndex = (UC)((aIndex + 1) & (CMPL_SHTMNGNUM - 1));					// indexçXêV
		}
	}
	else {
		if( gCMPL_Manager.seqMngInfo[0].sequenceId != CMPL_SEQ_ID_NUM ) {
			if( (gCMPL_Manager.seqMngInfo[0].actionLog & GET_BIT_PATTERN(aAction)) == 0 ) {
				CMPL_ExecuteSequence(aAction, 0);
			}
		}
	}

	if( CMPL_DownCompCheck() == true ) {
		CMPL_ChangeProcDownEvent();
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_InformedModuleEvent
// Description   : ÉÇÉWÉÖÅ[ÉãÉCÉxÉìÉgí ím
// Parameter     : aEvent (ÉÇÉWÉÖÅ[ÉãÉCÉxÉìÉg)
//				 : aSheetNo (ëŒè€ÉVÅ[ÉgÉiÉìÉoÅ[)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_InformedModuleEvent(ECMPL_ModuleEvent aEvent, UC aSheetNo)
{
	EvtParamSheetEventNotify aSheetEventMessage;
	 EvtParamSheetEventJamOccurrenceNotify aJamOccurenceMessage;

	switch( aEvent ) {
	case CMPL_EVT_EJECT_START:
		aSheetEventMessage.sheetNo = aSheetNo;
		CMPL_TMP_EjectStart(aSheetNo);
		MSP_SendMessage(MID_CMPL, EVT_SHT_EVT_OUT_TRAY_EJECT_START, (UC*)(&aSheetEventMessage), sizeof(aSheetEventMessage), LOG_OFF);
		break;

 	case CMPL_EVT_EJECT_COMP:
		aSheetEventMessage.sheetNo = aSheetNo;
		MSP_SendMessage(MID_CMPL, EVT_SHT_EVT_OUT_TRAY_EJECT_COMP, (UC*)(&aSheetEventMessage), sizeof(aSheetEventMessage), LOG_OFF);
		break;

	case CMPL_EVT_EJECT_SHEET_THROUGH:
		CMPL_TMP_EjectSheetThrough(aSheetNo);
		break;

	case CMPL_EVT_SET_EJECT_JAM_OCCUR:
		 aJamOccurenceMessage.statusNo = DSNO_SET_EJECT_JAM;
		 aJamOccurenceMessage.sheetNo = aSheetNo;

		 MSP_SendMessage(MID_CMPL, EVT_SHT_EVT_OUT_TRAY_JAM_OCCURRENCE, (UC*)(&aJamOccurenceMessage), sizeof(aJamOccurenceMessage), LOG_OFF);
		break;

	case  CMPL_EVT_STACKER_INIT_TRIGGER:  //Stacker Job Initialize start ..(GLOBAL_A4)
		aSheetEventMessage.sheetNo = aSheetNo;
		MSP_SendMessage(MID_CMPL, EVT_SHT_EVT_SHT_INIT_STACKER_JOBSTART, (UC*)(&aSheetEventMessage), sizeof(aSheetEventMessage), LOG_OFF);
		break;
		
	case  CMPL_EVT_STACKER_INIT_WAITING_POS_TRIGGER :
		aSheetEventMessage.sheetNo = aSheetNo;
		MSP_SendMessage(MID_CMPL, EVT_SHT_EVT_SHT_INIT_STACKER_WAITING_POS_START, (UC*)(&aSheetEventMessage), sizeof(aSheetEventMessage), LOG_OFF);
		break;
		
	case  CMPL_EVT_STACKER_JOB_TRIGGER1 :
		aSheetEventMessage.sheetNo = aSheetNo;
		MSP_SendMessage(MID_CMPL, EVT_SHT_EVT_TRAYJOB_TRIGGER_1, (UC*)(&aSheetEventMessage), sizeof(aSheetEventMessage), LOG_OFF);
		break;	
		
	default:
		break;
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_InformedDeviceStatusChange
// Description   : Device StatusÇÃïœâªÇí ím
// Parameter     : aStatusNo
//				 : aStatusValue
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_InformedDeviceStatusChange(EDeviceStatusNo aStatusNo, US aStatusValue)
{
	SRVC_UpdateDeviceStatus(aStatusValue, aStatusNo);
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_CurrentOFF
// Description   : ó„é•OFFìÆçÏ ÅF TamperÅ®Ejectó„é•OFFÇ∑ÇÈ
// Parameter     : aSheetno(ëŒè€ÉVÅ[ÉgÉiÉìÉoÅ[)
// History :  V3.6.93 édólïœçX ProcessEnd Sequence.
///////////////////////////////////////////////////////////////////
void CMPL_CurrentOFF(UC aSheetNo)
{	
	//Tamper OFF
	CMPL_TMP_StandbyEjectCompNotify();

	//Eject OFF
	CMPL_EJCT_CurrentOFF();

	CMPL_InformedModuleActionComp(CMPL_MDL_ACT_CURRENT_OFF, aSheetNo);
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_EventTimerTimeUp
// Description   : ÉCÉxÉìÉgÉ^ÉCÉ}ÇÃÉ^ÉCÉÄÉAÉbÉvéûèàóù
// Parameter     : aSheetno(ëŒè€ÉVÅ[ÉgÉiÉìÉoÅ[)
// Return        : 
///////////////////////////////////////////////////////////////////
void CMPL_EventTimerTimeUp(SS aTimerID, UL aEvtData)
{
	US aSheetNo = (US)(aEvtData & 0x000000FF);
	US aCompAct = (US)((aEvtData & 0xFFFFFF00) >> 8);

	CMPL_InformedModuleActionComp((ECMPL_ModuleAction)aCompAct, (UC)aSheetNo);
}


///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ComponentControl
// Description   : Component Control Stop Requestéwé¶éÛêMèàóù
// Parameter     : evt (ÉCÉxÉìÉgÉÅÉbÉZÅ[ÉW(Chain Link No.) )
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ComponentControl(const UC* evt, EAction aAction)
{
	UC aIndex;
	EvtParamComponentControlStartRequest *pRcvEvtParameter;
	EvtParamComponentControlStartNotify evtParameter;

	pRcvEvtParameter = (EvtParamComponentControlStartRequest *)evt;

	evtParameter.chainNo = pRcvEvtParameter->chainNo;
	evtParameter.linkNo = pRcvEvtParameter->linkNo;

	if ( evtParameter.chainNo == CMPL_COMPO_CHAIN) {
		for( aIndex = 0; aIndex < (sizeof(cCMPL_CompoContTbl) / sizeof(SCMPL_CompoCont)); aIndex++ ) {
			if( pRcvEvtParameter->linkNo == (US)(cCMPL_CompoContTbl[aIndex].link) ) {
				switch( cCMPL_CompoContTbl[aIndex].moduleID ) {
				case CMPL_MDL_ID_EJCT:
					CMPL_EJCT_ComponentControl(evtParameter.chainNo, evtParameter.linkNo, aAction);
					break;
				case CMPL_MDL_ID_STPL:
					CMPL_STPL_ComponentControl(evtParameter.chainNo, evtParameter.linkNo, aAction);
					break;
				case CMPL_MDL_ID_TMP:
					CMPL_TMP_ComponentControl(evtParameter.chainNo, evtParameter.linkNo, aAction);
					break;
				default:														// ñ¢íËã`ÇÃLink No.
					/* No Action */
					break;
				}
			}
		}
	}
	else {																		// ñ¢íËã`ÇÃChain No.
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_InformedCompoControlComplete
// Description   : Module Action Complete(Compiler Internal I/F)í íméÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_InformedCompoControlComplete(US aChainNo, US aLinkNo, EAction aAction)
{
	EvtParamComponentControlStopNotify aEvtParameter;

	aEvtParameter.chainNo = aChainNo;
	aEvtParameter.linkNo = aLinkNo;
	
	if( aAction == ACT_START ) {
		MSP_SendMessage(MID_CMPL, EVT_DIAG_COMPO_CONT_START, (const UC*)&aEvtParameter, sizeof(aEvtParameter), LOG_OFF);
	}
	else {																		// ACT_STOP
		MSP_SendMessage(MID_CMPL, EVT_DIAG_COMPO_CONT_STOP, (const UC*)&aEvtParameter, sizeof(aEvtParameter), LOG_OFF);
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_CompileExitSensorON
// Description   : Compile Exit Sensor ONåüímèàóù
// Parameter     : aSheetNo(éwíËSheet No.)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_CompileExitSensorON(UC aSheetNo)
{
	if (gCMPL_Manager.state != CMPL_STT_HARD_DOWN) {

		CMPL_TMP_Open(aSheetNo);
		if( SRVC_CheckSheetConditionNormal(aSheetNo) == true ){
			gCMPL_Manager.finishingWaitSheet = aSheetNo;
		}

	} else {

	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_CompileExitSensorOFF
// Description   : Compile Exit Sensor OFFåüímèàóù
// Parameter     : aSheetNo(éwíËSheet No.)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_CompileExitSensorOFF(UC aSheetNo)
{

	if ( gCMPL_Manager.state != CMPL_STT_HARD_DOWN) {

		CMPL_CompilerAction(aSheetNo, ACT_START);		
	
	} else { 
	
		CMPL_CompilerAction(aSheetNo, ACT_STOP);
	}
	gCMPL_Manager.finishingWaitSheet = SHEETNO_NUM;
}

void CMPL_CompileSheetEject()
{	
	if( (gCMPL_Manager.compileSheet != SHEETNO_NUM) && (SRVC_GetEject(gCMPL_Manager.compileSheet) == SHT_EJECT_EXEC) ) {
		if( gCMPL_Manager.ejectPossible == true ) {

			SRVC_UserDebugLog(0x55, gCMPL_Manager.compileSheet);				
			CMPL_StartCompilerAction(gCMPL_Manager.compileSheet);
		}
		else {
			/* No Action */
		}
	}
	else {
		/* No Action */
	}
}


///////////////////////////////////////////////////////////////////
// Function Name : CMPL_SheetAttributeUpdate
// Description   : ÉVÅ[ÉgÉAÉgÉäÉrÉÖÅ[ÉgçXêVéûèàóù
// Parameter     : aSheetNo(éwíËSheet No.)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_SheetAttributeUpdate(UC aSheetNo)
{
	if( SRVC_GetDestinationFinish(aSheetNo) == eCdiFinOutDest_OutTray ) {
		if( aSheetNo == gCMPL_Manager.compileSheet ) {
			CMPL_CompileSheetEject();
		}
		else {
			/* No Action */
		}
	}
	else {																		// != eCdiFinOutDest_OutTray
		/* No Action */
	}
}


///////////////////////////////////////////////////////////////////
// Function Name : CMPL_SheetAbort
// Description   : ÉVÅ[ÉgÉAÉ{Å[Égèàóù
// Parameter     : aSheetNo(éwíËSheet No.)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_SheetAbort()
{
	CMPL_EJCT_StopSheet(SHEETNO_NUM);
	CMPL_STPL_StopSheet(SHEETNO_NUM);
	CMPL_TMP_StopSheet(SHEETNO_NUM);

	if( gCMPL_Manager.compileSheet != SHEETNO_NUM ) {
		if( SRVC_CheckSheetConditionStop(gCMPL_Manager.compileSheet) == true ) {
			gCMPL_Manager.compileSheet = SHEETNO_NUM;
		}
	}

	// V3.4.0  T/B ëŒçÙ
	if( gCMPL_Manager.finishingWaitSheet != SHEETNO_NUM ) {
		if( SRVC_CheckSheetConditionStop(gCMPL_Manager.finishingWaitSheet) == true ) {
			gCMPL_Manager.finishingWaitSheet = SHEETNO_NUM; //
		}
	}
	//
	if( CMPL_DownCompCheck() == true ) {
		CMPL_ChangeProcDownEvent();
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_SheetDelivered
// Description   : ÉVÅ[ÉgÉfÉäÉoÅ[Éhèàóù
// Parameter     : aSheetNo(éwíËSheet No.)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_SheetDelivered()
{
	if( CMPL_DownCompCheck() == true ) {
		CMPL_ChangeProcDownEvent();
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveStartUp
// Description   : Start Upéwé¶éÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveStartUp()
{
	CMPL_ChangeStartUpEvent();
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceivePowerUpReq
// Description   : Power Up ReqéÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceivePowerUpReq()
{
	CMPL_ChangePowerUpEvent();
	CMPL_ChangePowerOnEvent();
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceivePowerDownReq
// Description   : Power Down ReqéÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceivePowerDownReq()
{
	CMPL_ChangePowerDownEvent();
	CMPL_ChangePowerOffEvent();
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveChangeNormalReq
// Description   : Change Normal ReqéÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveChangeNormalReq()
{
	CMPL_ChangeChangingStandbyEvent();
	CMPL_ChangeStandbyEvent();
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveChangeDiagReq
// Description   : Change Diag ReqéÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveChangeDiagReq()
{
	CMPL_ChangeChangingDiagEvent();
	CMPL_ChangeDiagEvent();
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveHardDownReq
// Description   : Hard Down ReqéÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveHardDownReq()
{

	CMPL_ChangeHardDownEvent();

	if( CMPL_DownCompCheck() == true ) {
		CMPL_ChangeProcDownEvent();
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveCycleDownReq
// Description   : Cycle Down ReqéÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveCycleDownReq()
{
	CMPL_ChangeCycleDownEvent();

	if( CMPL_DownCompCheck() == true ) {
		CMPL_ChangeProcDownEvent();
	}
	else {
		/* No Action */
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveDevActReqPowerOnInit
// Description   : Device Action Request(Power On Init)éwé¶éÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveDevActReqPowerOnInit()
{
	CMPL_PowerOnInit(ACT_START);
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveDevActReqResumeInit
// Description   : Device Action Request(Resume Init)éwé¶éÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveDevActReqResumeInit()
{
	CMPL_ResumeInit(ACT_START);
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveDevActReqNormalInit
// Description   : Device Action Request(Normal Init)éwé¶éÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveDevActReqNormalInit()
{
	CMPL_NormalInit(ACT_START);
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveDevActReqProcessEnd
// Description   : Device Action Request(Process End)éwé¶éÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveDevActReqProcessEnd()
{
	CMPL_ProcessEnd(ACT_START);
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveDevActReqJamClearAssist
// Description   : Device Action Request(Jam Clear Assist)éwé¶éÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveDevActReqJamClearAssist()
{
	CMPL_JamClearAssist(ACT_START);
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveDevEvtAnyCoverOpen
// Description   : Device Event Notify(Any Cover Open)éwé¶éÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveDevEvtAnyCoverOpen()
{
	gCMPL_Manager.ejectPossible = false;

	CMPL_EJCT_AnyCoverOpen();
	CMPL_STPL_AnyCoverOpen();
	CMPL_TMP_AnyCoverOpen();

	CMPL_StopPowerOnInit();
	CMPL_StopResumeInit();
	CMPL_StopNormalInit();
	CMPL_StopProcessEnd();
	CMPL_StopJamClearAssist();
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveDevEvtAllCoverClose
// Description   : Device Event Notify(All Cover Close)éwé¶éÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveDevEvtAllCoverClose()
{
	CMPL_EJCT_AllCoverClose();
	CMPL_STPL_AllCoverClose();
	CMPL_TMP_AllCoverClose();
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveDevEvtDevInitComp
// Description   : Device Event Notify(Device Initialize Complete)éwé¶éÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveDevEvtDevInitComp()
{
	if( CMPL_CheckEjectPossible() == true ) {
		gCMPL_Manager.ejectPossible = true;
	}

	CMPL_CompileSheetEject();
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveDevEvt24VCut
// Description   : Device Event Notify(24V Cut)éwé¶éÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveDevEvt24VCut()
{
	/* T.B.D. */
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveDevEvt24VCunnect
// Description   : Device Event Notify(24V Cunnect)éwé¶éÛêMèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveDevEvt24VCunnect()
{
	/* T.B.D. */
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveCompileExitSensorLead
// Description   : Compile Exit Senosr ONí íméÛêMèàóù
// Parameter     : evt (ÉCÉxÉìÉgÉÅÉbÉZÅ[ÉW(Location Event) )
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveCompileExitSensorLead(const UC* evt)
{
	LocationEvent* apLocationEvent = (LocationEvent*)evt;

	CMPL_CompileExitSensorON((UC)(apLocationEvent->mSheetNo));
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveCompileExitSensorTail
// Description   : Compile Exit Senosr OFFí íméÛêMèàóù
// Parameter     : evt (ÉCÉxÉìÉgÉÅÉbÉZÅ[ÉW(Location Event) )
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveCompileExitSensorTail(const UC* evt)
{
	LocationEvent* apLocationEvent = (LocationEvent*)evt;

	CMPL_CompileExitSensorOFF((UC)(apLocationEvent->mSheetNo));
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveSheetInitializeRequest
// Description   : Sheet Action Request(Sheet Initialize Request)éÛêMèàóù
// Parameter     : evt (ÉCÉxÉìÉgÉÅÉbÉZÅ[ÉW(Sheet Action Request) )
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveSheetInitializeRequest(const UC* evt)
{
	EvtParamSheetActionRequest* apSheetAction = (EvtParamSheetActionRequest*)evt;

	CMPL_SheetInitialize(apSheetAction->sheetNo, ACT_START);
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveCycleUpReq
// Description   : Cycle Up ReqéÛêMèàóù
// Parameter     : evt (Sheet Information )
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveCycleUpReq(const UC* evt)
{
	CMPL_ChangeCycleUpEvent();
	CMPL_ChangeReadyEvent();
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveStandbyNotify
// Description   : Standby NotifyéÛêMèàóù
// Parameter     : evt (Sheet Information )
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveStandbyNotify(const UC* evt)
{
	CMPL_ChangeStandbyEvent();

	if( CMPL_CheckEjectPossible() == true ) {
		gCMPL_Manager.ejectPossible = true;
	}

	CMPL_CompileSheetEject();
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveStandbyExitNotify
// Description   : Standby->CycleUp ëOèàóù(DeviceStop)
// Parameter     : evt (Sheet Information )
// Return        : Å]
///////////////////////////////////////////////////////////////////
UC  CMPL_ReceiveStandbyExitNotify(const UC* evt)
{
/*	UC aIndex;
	UC aSheetNo = SHEETNO_NUM;

	for( aIndex = 0; aIndex < CMPL_SHTMNGNUM; aIndex++ ) {

		if( gCMPL_Manager.seqMngInfo[aIndex].sheetNo != SHEETNO_NUM ) {
		
			if( gCMPL_Manager.seqMngInfo[aIndex].sequenceId == CMPL_SEQ_ID_STANDBY_EJECT_FINISHING ) {
				SRVC_UserDebugLog(0x53, 0x53);
				return true;				
			}
		}
	}	*/
	return false;
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveSheetInformationUpdate
// Description   : ÉVÅ[ÉgÉAÉgÉäÉrÉÖÅ[ÉgçXêVí íméÛêMèàóù
// Parameter     : evt (Sheet Information )
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveSheetInformationUpdate(const UC* evt)
{
	EvtParamSheetAttributeUpdate* apAttributeUpdate = (EvtParamSheetAttributeUpdate*)evt;

	CMPL_SheetAttributeUpdate((UC)(apAttributeUpdate->sheetNo));
}


///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveSheetInformationAbort
// Description   : ÉVÅ[ÉgÉAÉ{Å[Égí íméÛêMèàóù
// Parameter     : evt (Sheet Information )
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveSheetInformationAbort(const UC* evt)
{
	CMPL_SheetAbort();
}

///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ReceiveSheetInfomationDelivered
// Description   : ÉVÅ[ÉgÉfÉäÉoÅ[Éhí íméÛêMèàóù
// Parameter     : evt (Sheet Information )
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ReceiveSheetInfomationDelivered(const UC* evt)
{
	CMPL_SheetDelivered();
}



/////////////////////////////////////////////////////////////////////////////////////////
// Function Body (State)
/////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangeStartUpEvent
// Description   : Start UpëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangeStartUpEvent()
{
	UC aLoopCnt;
	
	gCMPL_Manager.state = CMPL_STT_UNKNOWN;
	gCMPL_Manager.ejectPossible = false;
	gCMPL_Manager.lastStaSeqIndex = 0;
	gCMPL_Manager.compileSheet = SHEETNO_NUM;
	gCMPL_Manager.finishingWaitSheet = SHEETNO_NUM;
	for( aLoopCnt = 0; aLoopCnt < CMPL_SHTMNGNUM; aLoopCnt++ ) {
		CMPL_ClearSequenceManageInfo(aLoopCnt);
	}

	CMPL_EJCT_Reset();
	CMPL_STPL_Reset();
	CMPL_TMP_Reset();

	CMPL_EJCT_SetUp();
	CMPL_STPL_SetUp();
	CMPL_TMP_SetUp();
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangePowerUpEvent
// Description   : Power UpëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangePowerUpEvent()
{
	if( gCMPL_Manager.state == CMPL_STT_UNKNOWN ) {

		/* No Action */

		gCMPL_Manager.state = CMPL_STT_POWER_UP;

		/* No Action */
	}
	else {
		/* No Action */
	}
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangePowerOnEvent
// Description   : Power OnëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangePowerOnEvent()
{
	if( gCMPL_Manager.state == CMPL_STT_POWER_UP ) {

		/* No Action */

		gCMPL_Manager.state = CMPL_STT_POWER_ON;

		MSP_SendMessage(MID_CMPL, EVT_STT_POWER_UP_RES, 0, 0, LOG_OFF);
	}
	else {
		/* No Action */
	}
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangePowerDownEvent
// Description   : Power DownëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangePowerDownEvent()
{
	if( (gCMPL_Manager.state == CMPL_STT_POWER_ON) || (gCMPL_Manager.state == CMPL_STT_STANDBY) || (gCMPL_Manager.state == CMPL_STT_DIAG) ) {
		
		/* No Action */
		
		gCMPL_Manager.state = CMPL_STT_POWER_DOWN;
		
		/* No Action */
		
	}
	else {
		/* No Action */
	}
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangePowerOffEvent
// Description   : Power OffëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangePowerOffEvent()
{
	if( gCMPL_Manager.state == CMPL_STT_POWER_DOWN ) {
		CMPL_EJCT_PowerOff();
		CMPL_STPL_PowerOff();
		CMPL_TMP_PowerOff();

		CMPL_StopPowerOnInit();
		CMPL_StopResumeInit();
		CMPL_StopNormalInit();
		CMPL_StopJamClearAssist();

		gCMPL_Manager.state = CMPL_STT_POWER_OFF;

		MSP_SendMessage(MID_CMPL, EVT_STT_POWER_DOWN_RES, 0, 0, LOG_OFF);
	}
	else {
		/* No Action */
	}
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangeChangingStandbyEvent
// Description   : ChaingingStandbyëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangeChangingStandbyEvent()
{
	ECMPL_State aSourceState;

	if( (gCMPL_Manager.state == CMPL_STT_POWER_ON) || (gCMPL_Manager.state == CMPL_STT_DIAG) ) {
		aSourceState = gCMPL_Manager.state;

		/* No Action */

		gCMPL_Manager.state = CMPL_STT_CHANGING_STANDBY;

		if( aSourceState == CMPL_STT_DIAG ) {
			CMPL_EJCT_SetUp();
			CMPL_STPL_SetUp();
			CMPL_TMP_SetUp();
		}
		else {
			/* No Action */
		}
	}
	else {
		/* No Action */
	}
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangeProcDownEvent
// Description   : ProcDownëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangeProcDownEvent()
{
	if( (gCMPL_Manager.state == CMPL_STT_CYCLE_DOWN) || (gCMPL_Manager.state == CMPL_STT_HARD_DOWN) ) {

		gCMPL_Manager.state = CMPL_STT_WAITING_STANDBY;
		SRVC_UserDebugLog(0x60, 0x60);
		MSP_SendMessage(MID_CMPL, EVT_STT_PROCESS_DOWN_RES, 0, 0, LOG_OFF);
	}
	else {
		/* No Action */
	}
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangeStandbyEvent
// Description   : StandbyëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangeStandbyEvent()
{
	ECMPL_State aSourceState;

	if( (gCMPL_Manager.state == CMPL_STT_WAITING_STANDBY) || (gCMPL_Manager.state == CMPL_STT_CHANGING_STANDBY) ) {
		aSourceState = gCMPL_Manager.state;

		if( aSourceState == CMPL_STT_CHANGING_STANDBY ) {
			CMPL_EJCT_Normal();
			CMPL_STPL_Normal();
			CMPL_TMP_Normal();
		}
		else {
			CMPL_EJCT_StopSteadyFinishing();
			CMPL_STPL_StopSteadyFinishing();
			CMPL_TMP_StopSteadyFinishing();
		}

		gCMPL_Manager.state = CMPL_STT_STANDBY;

		if( aSourceState == CMPL_STT_CHANGING_STANDBY ) {
			MSP_SendMessage(MID_CMPL, EVT_STT_CHANGE_NORMAL_RES, 0, 0, LOG_OFF);
		}
	}
	else {
		/* No Action */
	}
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangeCycleUpEvent
// Description   : CycleUpëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangeCycleUpEvent()
{
	if( gCMPL_Manager.state == CMPL_STT_STANDBY ) {

		CMPL_EJCT_ProcStart();
		CMPL_STPL_ProcStart();
		CMPL_TMP_ProcStart();

		gCMPL_Manager.state = CMPL_STT_CYCLE_UP;

		MSP_SendMessage(MID_CMPL, EVT_STT_CYCLE_UP_RES, 0, 0, LOG_OFF);

	}
	else {
		/* No Action */
	}
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangeReadyEvent
// Description   : ReadyëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangeReadyEvent()
{
	if( gCMPL_Manager.state == CMPL_STT_CYCLE_UP ) {
		/* No Action */

		gCMPL_Manager.state = CMPL_STT_READY;

		/* No Action */
	}
	else {
		/* No Action */
	}
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangeChangingDiagEvent
// Description   : ChangingDiagëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangeChangingDiagEvent()
{
	if( (gCMPL_Manager.state == CMPL_STT_POWER_ON) || (gCMPL_Manager.state == CMPL_STT_STANDBY) ) {
		
		/* No Action */
		
		gCMPL_Manager.state = CMPL_STT_CHANGING_DIAG;
		
		/* No Action */
		
	}
	else {
		/* No Action */
	}
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangeDiagEvent
// Description   : DiagëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangeDiagEvent()
{
	if( gCMPL_Manager.state == CMPL_STT_CHANGING_DIAG ) {
		CMPL_StopPowerOnInit();
		CMPL_StopResumeInit();
		CMPL_StopNormalInit();
		CMPL_StopJamClearAssist();

		CMPL_EJCT_Diag();
		CMPL_STPL_Diag();
		CMPL_TMP_Diag();

		gCMPL_Manager.state = CMPL_STT_DIAG;

		MSP_SendMessage(MID_CMPL, EVT_STT_CHANGE_DIAG_RES, 0, 0, LOG_OFF);
	}
	else {
		/* No Action */
	}
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangeHardDownEvent
// Description   : Hard DownëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangeHardDownEvent()
{
	UC aIndex;

	if( (gCMPL_Manager.state == CMPL_STT_READY) || (gCMPL_Manager.state == CMPL_STT_CYCLE_UP) || (gCMPL_Manager.state == CMPL_STT_CYCLE_DOWN) ) {

		gCMPL_Manager.ejectPossible = false;

		gCMPL_Manager.state = CMPL_STT_HARD_DOWN;

		CMPL_EJCT_StopModuleAction();
		CMPL_STPL_StopModuleAction();
		CMPL_TMP_StopModuleAction();

		for( aIndex = 0; aIndex < CMPL_SHTMNGNUM; aIndex++ ) {
			if( gCMPL_Manager.seqMngInfo[aIndex].sheetNo != SHEETNO_NUM ) {
				CMPL_StopSheetInitialize(gCMPL_Manager.seqMngInfo[aIndex].sheetNo);
				CMPL_StopCompilerAction(gCMPL_Manager.seqMngInfo[aIndex].sheetNo);
			}
			else {
				/* No Action */
			}
		}
		gCMPL_Manager.finishingWaitSheet = SHEETNO_NUM;
	}
	else {
		/* No Action */
	}
}

//////////////////////////////////////////////////////////////////
// Function Name : CMPL_ChangeCycleDownEvent
// Description   : Cycle DownëJà⁄ÉCÉxÉìÉgèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CMPL_ChangeCycleDownEvent()
{
	if( (gCMPL_Manager.state == CMPL_STT_READY) || (gCMPL_Manager.state == CMPL_STT_CYCLE_UP) ) {

		gCMPL_Manager.ejectPossible = false;

		gCMPL_Manager.state = CMPL_STT_CYCLE_DOWN;

		/* No Action */
		PutCMPLManagerLog(0x22, 0x22, 0, 0);

	}
	else {
		/* No Action */
	}
}
///////////////////////////////////////////////////////////////////
// Function Name : PutCMPLManagerLog
// Description   : ÉVÅ[ÉgÉçÉPÅ[ÉVÉáÉìÉçÉOèoóÕéwé¶èàóù
// Parameter     : para1 (êîéöóÒÇÃç≈èâÇ…ïtâ¡Ç∑ÇÈíl)
//               : para2 (êîéöóÒÇÃÇQî‘ñ⁄Ç…ïtâ¡Ç∑ÇÈíl)
//               : para3 (êîéöóÒÇÃÇRî‘ñ⁄Ç…ïtâ¡Ç∑ÇÈíl)
//               : para4 (êîéöóÒÇÃÇSî‘ñ⁄Ç…ïtâ¡Ç∑ÇÈíl)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void PutCMPLManagerLog(UC para1, UC para2, US para3, US para4)
{
	UC log[6];

	log[0] = para1;
	log[1] = para2;
	log[2] = (UC) (para3 >>8 ) ;
	log[3] = (UC) (para3 & 0x00FF);	
	log[4] = (UC) (para4 >>8 ) ;
	log[5] = (UC) (para4 & 0x00FF);	

	DD_LOG_Put(LOGID_CMPL_Mgr, 'S', log, sizeof(log), LOG_CATEGORY_DEBUG);
}





