// File Name:	CKeyInformer.c
// Description:	Implimentation File of Key Data Informer
// Engineer:	Yuichi Hoshino
// Last Edit:	16.02.09
// Revision:	01
//
// Copyright (C) by Fuji Xerox Advanced Technology Co.,Ltd. All rights reserved.
//


/////////////////////////////////////////////////////////////////////////////////////////
// Include File
/////////////////////////////////////////////////////////////////////////////////////////

#include "CKeyInformer.h"

#include "KeyArea.h"

#include "CSysManager.h"
#include "CNmaHandler.h" 


/////////////////////////////////////////////////////////////////////////////////////////
// Constant Number Definition
/////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////
// Type Definition
/////////////////////////////////////////////////////////////////////////////////////////

// --- Member of Key Data Informer ---
typedef struct /*CKeyInformerMember*/
{
	KEY_AREA_TYPE mKeyRamArea;
	UC mNvmChange;
} CKeyInformerMember;


/////////////////////////////////////////////////////////////////////////////////////////
// Private Function Prototype Definition
/////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////////////
// Private Data Definition
/////////////////////////////////////////////////////////////////////////////////////////

// --- Member of Key Data Informer ---
static CKeyInformerMember gKey_InformerMember;


/////////////////////////////////////////////////////////////////////////////////////////
// Private Function Prototype Definition
/////////////////////////////////////////////////////////////////////////////////////////

static void LoadNvmComplete(SS result);
static void SaveNvmComplete(SS result);


/////////////////////////////////////////////////////////////////////////////////////////
// Function Body
/////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_Constructor
// Description   : ÉRÉìÉXÉgÉâÉNÉ^
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CKeyInformer_Constructor()
{
	UC index;

	gKey_InformerMember.mKeyRamArea.SIZE.KEYCODE = 0;
	gKey_InformerMember.mKeyRamArea.SIZE.DLMODE  = DOWNLOAD_MODE_COMPLETE;
	gKey_InformerMember.mKeyRamArea.SIZE.MAJOR_V = 0;
	gKey_InformerMember.mKeyRamArea.SIZE.MINOR_V = 0;
	gKey_InformerMember.mKeyRamArea.SIZE.PATCH_V = 0;
	gKey_InformerMember.mKeyRamArea.SIZE.SEQ_BIT = 0;
	gKey_InformerMember.mKeyRamArea.SIZE.WRTCNT  = 0;
	gKey_InformerMember.mKeyRamArea.SIZE.IPL_V	 = 0;

	for ( index = 0; index < (KEY_AREA_SIZE - KEY_AREA_USE_SIZE); index++ ){
		gKey_InformerMember.mKeyRamArea.SIZE.CONFIG[index] = 0;
	}

	gKey_InformerMember.mNvmChange = KEY_NO_CHANGE;
}

///////////////////////////////////////////////////////////////////
// Function Name : LoadNvmComplete
// Description   : NVMÇÃÉçÅ[ÉhäÆóπéûèàóù
// Parameter     : result
// Return        : Å]
///////////////////////////////////////////////////////////////////
void LoadNvmComplete(SS result)
{
	CNmaHandler_LoadNvmComplete(NMA_INFORMER_KEY, result);
}

///////////////////////////////////////////////////////////////////
// Function Name : SaveNvmComplete
// Description   : NVMÇÃÉZÅ[ÉuäÆóπéûèàóù
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void SaveNvmComplete(SS result)
{
	CNmaHandler_SaveNvmComplete(NMA_INFORMER_KEY, result);
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_LoadNvm
// Description   : NVMÇÃÉçÅ[ÉhàÀóä
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CKeyInformer_LoadNvm()
{
	DD_NVM_Load(DD_NVM_AREA_KEY, (UC *)(&(gKey_InformerMember.mKeyRamArea)), KEY_AREA_SIZE, LoadNvmComplete);
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_SaveNvm
// Description   : NVMÇÃÉZÅ[ÉuàÀóä
// Parameter     : Å]
// Return        : true = ÉZÅ[ÉuàÀóäéÛóù(ÉZÅ[ÉuèàóùäJén)
//               : false = ÉZÅ[Éuèàóùãëê‚
///////////////////////////////////////////////////////////////////
bool CKeyInformer_SaveNvm()
{
	if ( gKey_InformerMember.mNvmChange == KEY_CHANGE ){
		(gKey_InformerMember.mKeyRamArea.SIZE.WRTCNT)++;

		DD_NVM_Save(DD_NVM_AREA_KEY, (UC *)(&(gKey_InformerMember.mKeyRamArea)), KEY_AREA_SIZE, SaveNvmComplete);

		return true;
	}
	else{
		return false;
	}
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_CheckKeyCode
// Description   : KeyCodeÇÃèâä˙âªçœÇ›É`ÉFÉbÉN
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
bool CKeyInformer_CheckKeyCode()
{
	if ( gKey_InformerMember.mKeyRamArea.SIZE.KEYCODE == KEY_CODE ) return true;
	else															return false;
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_SetKeyCode
// Description   : KeyCodeÇ÷èâä˙âªçœÇ›Çê›íË
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CKeyInformer_SetKeyCode()
{
	if ( gKey_InformerMember.mKeyRamArea.SIZE.KEYCODE != KEY_CODE ){
		gKey_InformerMember.mKeyRamArea.SIZE.KEYCODE = KEY_CODE;

		gKey_InformerMember.mNvmChange = KEY_CHANGE;
	}
	else{ /* No Action */ }
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_ClearKeyCode
// Description   : KeyCodeÇ÷ñ¢èâä˙âªÇê›íË
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CKeyInformer_ClearKeyCode()
{
	if ( gKey_InformerMember.mKeyRamArea.SIZE.KEYCODE == KEY_CODE ){
		gKey_InformerMember.mKeyRamArea.SIZE.KEYCODE = 0;

		gKey_InformerMember.mNvmChange = KEY_CHANGE;
	}
	else{ /* No Action */ }
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_CheckDownloadMode
// Description   : DownloadModeÉ`ÉFÉbÉN
// Parameter     : Å]
// Return        : 
///////////////////////////////////////////////////////////////////
bool CKeyInformer_CheckDownloadMode()
{
	if ( gKey_InformerMember.mKeyRamArea.SIZE.DLMODE == DOWNLOAD_MODE_COMPLETE ) return false;
	else																		 return true;
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_SetDownloadMode
// Description   : DownloadModeê›íË
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CKeyInformer_SetDownloadMode()
{
	if ( gKey_InformerMember.mKeyRamArea.SIZE.DLMODE != DOWNLOAD_MODE_CHANGE ){
		gKey_InformerMember.mKeyRamArea.SIZE.DLMODE = DOWNLOAD_MODE_CHANGE;

		gKey_InformerMember.mNvmChange = KEY_CHANGE;
	}
	else{ /* No Action */ }
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_ClearDownloadMode
// Description   : DownloadModeâèú
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CKeyInformer_ClearDownloadMode()
{
	if ( gKey_InformerMember.mKeyRamArea.SIZE.DLMODE != DOWNLOAD_MODE_COMPLETE ){
		gKey_InformerMember.mKeyRamArea.SIZE.DLMODE = DOWNLOAD_MODE_COMPLETE;

		gKey_InformerMember.mNvmChange = KEY_CHANGE;
	}
	else{ /* No Action */ }
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_SetMajorVersion
// Description   : Major Versionê›íË
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CKeyInformer_SetMajorVersion(UC version)
{
	if ( gKey_InformerMember.mKeyRamArea.SIZE.MAJOR_V != version ){
		gKey_InformerMember.mKeyRamArea.SIZE.MAJOR_V = version;

		gKey_InformerMember.mNvmChange = KEY_CHANGE;
	}
	else{ /* No Action */ }
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_GetMajorVersion
// Description   : Major VersionéÊìæ
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
UC CKeyInformer_GetMajorVersion()
{
	return gKey_InformerMember.mKeyRamArea.SIZE.MAJOR_V;
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_SetMinorVersion
// Description   : Minor Versionê›íË
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CKeyInformer_SetMinorVersion(UC version)
{
	if ( gKey_InformerMember.mKeyRamArea.SIZE.MINOR_V != version ){
		gKey_InformerMember.mKeyRamArea.SIZE.MINOR_V = version;

		gKey_InformerMember.mNvmChange = KEY_CHANGE;
	}
	else{ /* No Action */ }
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_GetMinorVersion
// Description   : Minor VersionéÊìæ
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
UC CKeyInformer_GetMinorVersion()
{
	return gKey_InformerMember.mKeyRamArea.SIZE.MINOR_V;
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_SetPatchVersion
// Description   : Patch Versionê›íË
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CKeyInformer_SetPatchVersion(UC version)
{
	if ( gKey_InformerMember.mKeyRamArea.SIZE.PATCH_V != version ){
		gKey_InformerMember.mKeyRamArea.SIZE.PATCH_V = version;

		gKey_InformerMember.mNvmChange = KEY_CHANGE;
	}
	else{ /* No Action */ }
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_GetPatchVersion
// Description   : Patch VersionéÊìæ
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
UC CKeyInformer_GetPatchVersion()
{
	return gKey_InformerMember.mKeyRamArea.SIZE.PATCH_V;
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_GetWriteCount
// Description   : èëÇ´çûÇ›âÒêîéÊìæ
// Parameter     : Å]
// Return        : Å]
///////////////////////////////////////////////////////////////////
UL CKeyInformer_GetWriteCount()
{
	return gKey_InformerMember.mKeyRamArea.SIZE.WRTCNT;
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_SetRxSequenceBit 
// Description   : RxÉVÅ[ÉPÉìÉXÉrÉbÉgÉZÉbÉgèàóù
// Parameter     : seqBit (ÉVÅ[ÉPÉìÉXÉrÉbÉg) [0/1]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CKeyInformer_SetRxSequenceBit(UC seqBit)
{
//	if ( ((gKey_InformerMember.mKeyRamArea.SIZE.SEQ_BIT >> SEQUENCE_BIT_SAVE_POS_RX) & 0x01) != seqBit ){
//																				// DownloadéûÇÕDownload ModeèëÇ´çûÇ›Ç™Ç†ÇËÅAïKÇ∏èëÇ´çûÇ›èàóùëŒè€Ç∆Ç»ÇÈÇΩÇﬂïœâªÉ`ÉFÉbÉNÇÕçsÇÌÇ»Ç¢
		gKey_InformerMember.mKeyRamArea.SIZE.SEQ_BIT &= ~(SEQUENCE_BIT_SAVE_POS_PTN(SEQUENCE_BIT_SAVE_POS_RX));
																				// ëŒè€ÉrÉbÉgÇÉNÉäÉA
		gKey_InformerMember.mKeyRamArea.SIZE.SEQ_BIT |= ((seqBit & 0x01) << SEQUENCE_BIT_SAVE_POS_RX);

		gKey_InformerMember.mNvmChange = KEY_CHANGE;
//	}
//	else{ /* No Action */ }
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_GetRxSequenceBit
// Description   : RxÉVÅ[ÉPÉìÉXÉrÉbÉgéÊìæèàóù
// Parameter     : Å]
// Return        : ÉVÅ[ÉPÉìÉXÉrÉbÉg [0/1]
///////////////////////////////////////////////////////////////////
UC CKeyInformer_GetRxSequenceBit()
{
	return (gKey_InformerMember.mKeyRamArea.SIZE.SEQ_BIT >> SEQUENCE_BIT_SAVE_POS_RX) & 0x01;
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_SetTxSequenceBit
// Description   : TxÉVÅ[ÉPÉìÉXÉrÉbÉgÉZÉbÉgèàóù
// Parameter     : seqBit (ÉVÅ[ÉPÉìÉXÉrÉbÉg) [0/1]
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CKeyInformer_SetTxSequenceBit(UC seqBit)
{
//	if ( ((gKey_InformerMember.mKeyRamArea.SIZE.SEQ_BIT >> SEQUENCE_BIT_SAVE_POS_TX) & 0x01) != seqBit ){
//																				// DownloadéûÇÕDownload ModeèëÇ´çûÇ›Ç™Ç†ÇËÅAïKÇ∏èëÇ´çûÇ›èàóùëŒè€Ç∆Ç»ÇÈÇΩÇﬂïœâªÉ`ÉFÉbÉNÇÕçsÇÌÇ»Ç¢
		gKey_InformerMember.mKeyRamArea.SIZE.SEQ_BIT &= ~(SEQUENCE_BIT_SAVE_POS_PTN(SEQUENCE_BIT_SAVE_POS_TX));
																				// ëŒè€ÉrÉbÉgÇÉNÉäÉA
		gKey_InformerMember.mKeyRamArea.SIZE.SEQ_BIT |= ((seqBit & 0x01) << SEQUENCE_BIT_SAVE_POS_TX);

		gKey_InformerMember.mNvmChange = KEY_CHANGE;
//	}
//	else{ /* No Action */ }
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_GetTxSequenceBit
// Description   : TxÉVÅ[ÉPÉìÉXÉrÉbÉgéÊìæèàóù
// Parameter     : Å]
// Return        : ÉVÅ[ÉPÉìÉXÉrÉbÉg [0/1]
///////////////////////////////////////////////////////////////////
UC CKeyInformer_GetTxSequenceBit()
{
	return (gKey_InformerMember.mKeyRamArea.SIZE.SEQ_BIT >> SEQUENCE_BIT_SAVE_POS_TX) & 0x01;
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_SetIplVersion
// Description   : IPL VersionÉZÉbÉgèàóù
// Parameter     : version (IPL Version)
// Return        : Å]
///////////////////////////////////////////////////////////////////
void CKeyInformer_SetIplVersion(UC version)
{
	if ( gKey_InformerMember.mKeyRamArea.SIZE.IPL_V != version ){ 
		gKey_InformerMember.mKeyRamArea.SIZE.IPL_V = version;

		gKey_InformerMember.mNvmChange = KEY_CHANGE;
	}
	else{ /* No Action */ }
}

///////////////////////////////////////////////////////////////////
// Function Name : CKeyInformer_GetIplVersion
// Description   : IPL VersionéÊìæèàóù
// Parameter     : Å]
// Return        : IPL Version
///////////////////////////////////////////////////////////////////
UC CKeyInformer_GetIplVersion()
{
	return gKey_InformerMember.mKeyRamArea.SIZE.IPL_V;
}


// Change History
// Date:	| Engineer:			| Note:
// ---------+-------------------+--------------------------------------------------------
// 15.03.31	| Yuichi Hoshino	| Created this file based on Base SW V1
// 15.06.19	| Yuichi Hoshino	| Introduction Spec [ NVM Failå¥àˆÉçÉOëóêM ]
// 15.06.19	| Yuichi Hoshino	| Release Revision 00 to GA-Finisher V0.1.0 Make.
// 16.02.09	| Yuichi Hoshino	| Introduction Spec [ Download ]
// 16.03.01	| Yuichi Hoshino	| Release Revision 01 to GA-Finisher V1.20.0 Make.
//
